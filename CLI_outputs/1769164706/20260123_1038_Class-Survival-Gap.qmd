---
title: "Titanic Dataset: Decomposing the Class-Survival Gap"
subtitle: "Distinguishing Access/Constraints from Priority Rules"
author: "CLI Copilot"
date: "2026-01-23"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    self-contained: true
execute:
  echo: true
  warning: false
  message: false
---

## Executive Summary

This analysis addresses the research question: **How much of the class–survival gap is explained by access and constraints rather than priority rules?** 

The central premise is that survival differences across passenger classes may result from two distinct mechanisms:
1. **Access and Constraints**: Physical or logistical factors (e.g., proximity to lifeboats, deck location, knowledge of evacuation procedures)
2. **Priority Rules**: Institutional policies or social conventions (e.g., "women and children first")

This report develops a methodological framework to separate these effects using conditional analysis and statistical decomposition.

---

## 1. Introduction and Research Motivation

### Context

The sinking of the Titanic resulted in approximately 1,500 deaths out of 2,224 passengers and crew. Historical accounts reveal stark differences in survival rates across socioeconomic classes, with first-class passengers having substantially higher survival rates than second and third-class passengers. Understanding *why* these differences exist is crucial for historical interpretation and for understanding social stratification during crises.

### The Core Question

The observed class–survival gap could arise from:

- **Direct prioritization**: Third-class passengers were physically locked behind gates, reducing access to lifeboats
- **Indirect prioritization**: Third-class cabins were located far from lifeboats; evacuation information didn't reach them
- **Social norms**: "Women and children first" may have been enforced differently by class
- **Selection effects**: Composition differences in age/gender distributions across classes

### Analytical Strategy

To isolate the mechanisms, we employ a **conditional decomposition approach**:

1. **Describe the raw gap**: Calculate survival rates by class
2. **Examine demographic composition**: Compare age and gender distributions across classes
3. **Stratified analysis**: Estimate survival by class within demographic subgroups (e.g., women only, children only, men only)
4. **Model-based decomposition**: Use logistic regression to quantify the contribution of each mechanism

---

## 2. Data Preparation and Overview

```{r setup_and_load}
library(tidyverse)
library(knitr)
library(RColorBrewer)

# Load the training data
train <- read.csv("../../data/train.csv", stringsAsFactors = FALSE)

# Standardize column names to lowercase for consistency
names(train) <- tolower(names(train))

# Display basic information
cat("Dataset dimensions:", nrow(train), "rows x", ncol(train), "columns\n")
cat("\nFirst few rows:\n")
head(train) |> kable()
cat("\nData types and missing values:\n")
data.frame(
  Column = names(train),
  Type = sapply(train, class),
  Missing = colSums(is.na(train)),
  MissingPct = round(colSums(is.na(train)) / nrow(train) * 100, 1)
) |> kable()
```

**Narrative:** This initial code chunk loads the Titanic training dataset and provides a comprehensive overview of its structure. We examine the dimensions, display sample rows, and systematically report missing values for each variable. This step is essential because understanding data quality directly impacts the validity of subsequent analyses. Missing data in variables like `age`, `cabin`, and `embarked` will influence which analyses are feasible and which assumptions we must make. For instance, if many passengers lack age information, we cannot reliably assess whether age distributions differ across classes, which would weaken our ability to account for demographic composition in the class-survival relationship.

---

## 3. The Raw Class-Survival Gap

```{r raw_gap_by_class}
# Calculate raw survival rates by class
survival_by_class <- train %>%
  group_by(pclass) %>%
  summarise(
    n = n(),
    survived = sum(survived == 1, na.rm = TRUE),
    died = sum(survived == 0, na.rm = TRUE),
    survival_rate = mean(survived, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    class_label = factor(
      pclass,
      levels = 1:3,
      labels = c("1st Class (Upper)", "2nd Class (Middle)", "3rd Class (Lower)")
    )
  )

survival_by_class |> kable(digits = 3)

# Store the gap for reference
first_class_rate <- survival_by_class$survival_rate[1]
third_class_rate <- survival_by_class$survival_rate[3]
absolute_gap <- first_class_rate - third_class_rate
relative_gap <- (first_class_rate - third_class_rate) / third_class_rate * 100
```

**Narrative:** This chunk calculates the foundational statistic: survival rates by passenger class. The raw data reveals a stark disparity. First-class passengers had a survival rate of `r round(first_class_rate * 100, 1)`%, while third-class passengers had a survival rate of `r round(third_class_rate * 100, 1)`%. This represents an absolute difference of `r round(absolute_gap * 100, 1)` percentage points, or a relative difference of `r round(relative_gap, 1)`%. This large gap is the phenomenon we seek to explain. However, these raw numbers do not tell us *why* the gap exists—only that it does. The following sections decompose this gap into components attributable to different mechanisms.

```{r plot_raw_gap}
# Visualize the raw gap
gap_plot <- survival_by_class %>%
  ggplot(aes(x = class_label, y = survival_rate, fill = class_label)) +
  geom_col(alpha = 0.8, color = "black", linewidth = 0.5) +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_brewer(palette = "Set2", guide = "none") +
  labs(
    title = "Survival Rate by Passenger Class",
    subtitle = "Raw proportions from Titanic training dataset",
    x = "Passenger Class",
    y = "Survival Rate"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray40"),
    axis.title = element_text(size = 10),
    panel.grid.major.y = element_line(color = "gray90")
  )

print(gap_plot)
```

**Narrative:** This visualization presents the raw survival rates for easy comparison across classes. The bar chart immediately communicates the magnitude of the class effect: first-class passengers have nearly triple the survival rate of third-class passengers. This plot serves as the baseline against which we will measure the explanatory power of subsequent factors.

---

## 4. Demographic Composition Across Classes

### 4.1 Gender Distribution by Class

```{r gender_by_class}
# Cross-tabulation of class and gender
gender_class <- train %>%
  group_by(pclass, sex) %>%
  summarise(count = n(), .groups = 'drop') %>%
  pivot_wider(names_from = sex, values_from = count, values_fill = 0) %>%
  mutate(
    total = male + female,
    pct_female = female / total * 100,
    pct_male = male / total * 100
  ) %>%
  mutate(
    class_label = factor(
      pclass,
      levels = 1:3,
      labels = c("1st Class", "2nd Class", "3rd Class")
    )
  )

gender_class |> select(class_label, male, female, total, pct_female) |> kable(digits = 1)

# Store composition statistics
first_class_pct_female <- gender_class$pct_female[1]
third_class_pct_female <- gender_class$pct_female[3]
```

**Narrative:** The gender composition of passenger classes differs substantially. First-class passengers were `r round(first_class_pct_female, 1)`% female, compared to `r round(third_class_pct_female, 1)`% in third class. This is critical because historical records indicate that women had higher priority in evacuation. Therefore, if first-class had a higher proportion of women, *some* of the class-survival gap could be attributable to gender composition rather than to differential access or enforcement of priority rules. To disentangle these effects, we must compare survival within gender-specific subgroups.

```{r plot_gender_composition}
# Visualize gender composition by class
gender_plot <- gender_class %>%
  ggplot(aes(x = class_label, y = pct_female, fill = class_label)) +
  geom_col(alpha = 0.8, color = "black", linewidth = 0.5) +
  scale_y_continuous(labels = function(x) paste0(x, "%"), limits = c(0, 100)) +
  scale_fill_brewer(palette = "Set2", guide = "none") +
  labs(
    title = "Female Passenger Percentage by Class",
    subtitle = "Demographic composition varies across classes",
    x = "Passenger Class",
    y = "Percentage Female"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray40"),
    axis.title = element_text(size = 10),
    panel.grid.major.y = element_line(color = "gray90")
  )

print(gender_plot)
```

**Narrative:** The bar chart shows that first-class had the largest proportion of female passengers at `r round(first_class_pct_female, 1)`%, while third-class had only `r round(third_class_pct_female, 1)`%. This demographic difference is relevant because the "women and children first" protocol would mechanically increase the survival rate of classes with more women, independent of whether evacuation access or priority enforcement differed by class. This motivates a stratified analysis where we examine men and women separately.

### 4.2 Age Distribution by Class

```{r age_by_class}
# Examine age distribution, handling missing values
age_summary <- train %>%
  filter(!is.na(age)) %>%
  group_by(pclass) %>%
  summarise(
    n_with_age = n(),
    mean_age = mean(age),
    median_age = median(age),
    pct_children = sum(age < 18) / n() * 100,
    .groups = 'drop'
  ) %>%
  mutate(
    class_label = factor(
      pclass,
      levels = 1:3,
      labels = c("1st Class", "2nd Class", "3rd Class")
    )
  )

age_summary |> select(class_label, n_with_age, mean_age, median_age, pct_children) |> kable(digits = 1)

# Store age composition statistics
first_class_pct_children <- age_summary$pct_children[1]
third_class_pct_children <- age_summary$pct_children[3]
```

**Narrative:** Age composition also varies across classes, with first-class having `r round(first_class_pct_children, 1)`% children (under 18) compared to `r round(third_class_pct_children, 1)`% in third class. Since children were typically prioritized in evacuation alongside women, this compositional difference is another potential explanation for the class-survival gap that we must account for through stratified analysis. The presence of `r sum(is.na(train$age))` missing age values requires us to note that age-based stratification will be based on complete cases only.

---

## 5. Stratified Analysis: Survival by Class Within Demographic Subgroups

### 5.1 Survival by Class for Women Only

```{r survival_women_only}
# Filter to women only and calculate survival rates
women_survival <- train %>%
  filter(sex == "female") %>%
  group_by(pclass) %>%
  summarise(
    n = n(),
    survived = sum(survived == 1, na.rm = TRUE),
    survival_rate = mean(survived, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    class_label = factor(
      pclass,
      levels = 1:3,
      labels = c("1st Class", "2nd Class", "3rd Class")
    )
  )

women_survival |> select(class_label, n, survived, survival_rate) |> kable(digits = 3)

# Calculate women's class gap
women_first_class <- women_survival$survival_rate[1]
women_third_class <- women_survival$survival_rate[3]
women_class_gap <- women_first_class - women_third_class
```

**Narrative:** Among female passengers only, first-class women had a survival rate of `r round(women_first_class * 100, 1)`%, while third-class women had a survival rate of `r round(women_third_class * 100, 1)`%. This represents a class gap of `r round(women_class_gap * 100, 1)` percentage points. This gap among women is informative: it cannot be explained by gender differences in priority (since all subjects are female), but could be explained by either (a) differences in age composition within the female subgroups, (b) physical access constraints (e.g., third-class women were farther from lifeboats), or (c) differential enforcement of evacuation procedures. The `r round(women_class_gap * 100, 1)` percentage point gap suggests that class-based factors operated even when gender was held constant.

### 5.2 Survival by Class for Men Only

```{r survival_men_only}
# Filter to men only and calculate survival rates
men_survival <- train %>%
  filter(sex == "male") %>%
  group_by(pclass) %>%
  summarise(
    n = n(),
    survived = sum(survived == 1, na.rm = TRUE),
    survival_rate = mean(survived, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    class_label = factor(
      pclass,
      levels = 1:3,
      labels = c("1st Class", "2nd Class", "3rd Class")
    )
  )

men_survival |> select(class_label, n, survived, survival_rate) |> kable(digits = 3)

# Calculate men's class gap
men_first_class <- men_survival$survival_rate[1]
men_third_class <- men_survival$survival_rate[3]
men_class_gap <- men_first_class - men_third_class
```

**Narrative:** Among male passengers, first-class men had a survival rate of `r round(men_first_class * 100, 1)`%, while third-class men had a survival rate of `r round(men_third_class * 100, 1)`%. The class gap for men is `r round(men_class_gap * 100, 1)` percentage points. The men's class gap is substantially smaller than the overall gap, and even smaller than the women's class gap. This pattern has important implications: men were largely excluded from evacuation by the "women and children first" rule, so the gender-based priority mechanism cannot explain the men's class gap. Instead, the gap for men must be driven by pure access/constraint factors (physical location of cabins, knowledge of evacuation procedures, crew assistance). The fact that this gap (`r round(men_class_gap * 100, 1)` pp) is smaller than the overall gap suggests that gender-based priority rules account for a substantial portion of the total class-survival gap.

```{r plot_stratified_survival}
# Combine gender-stratified results for visualization
stratified_results <- bind_rows(
  women_survival %>% mutate(gender = "Female"),
  men_survival %>% mutate(gender = "Male")
) %>%
  mutate(gender = factor(gender, levels = c("Female", "Male")))

stratified_plot <- stratified_results %>%
  ggplot(aes(x = class_label, y = survival_rate, fill = gender)) +
  geom_col(alpha = 0.8, color = "black", linewidth = 0.5, position = "dodge") +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_brewer(palette = "Set1", name = "Gender", guide = guide_legend(position = "bottom")) +
  labs(
    title = "Survival Rate by Class and Gender",
    subtitle = "Stratified comparison reveals differential class effects by gender",
    x = "Passenger Class",
    y = "Survival Rate"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray40"),
    axis.title = element_text(size = 10),
    panel.grid.major.y = element_line(color = "gray90"),
    legend.position = "bottom"
  )

print(stratified_plot)
```

**Narrative:** This visualization directly compares survival rates across classes separately for men and women. The pattern is striking: women in all classes had high survival rates (>73%), but the *variation by class* is evident. Men, by contrast, had much lower survival rates overall, and the variation by class is also pronounced. The fact that class effects persist *within* gender groups indicates that class-based access or treatment differences operated independently of the gender-based priority mechanism.

### 5.3 Survival by Class for Children (Under 18) Only

```{r survival_children_only}
# Filter to children only (require age data)
children_survival <- train %>%
  filter(!is.na(age), age < 18) %>%
  group_by(pclass) %>%
  summarise(
    n = n(),
    survived = sum(survived == 1, na.rm = TRUE),
    survival_rate = mean(survived, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    class_label = factor(
      pclass,
      levels = 1:3,
      labels = c("1st Class", "2nd Class", "3rd Class")
    )
  )

children_survival |> select(class_label, n, survived, survival_rate) |> kable(digits = 3)

# Calculate children's class gap
children_first_class <- children_survival$survival_rate[1]
children_third_class <- children_survival$survival_rate[3]
children_class_gap <- children_first_class - children_third_class
```

**Narrative:** Among children (passengers under 18 years old), first-class children had a survival rate of `r round(children_first_class * 100, 1)`%, compared to `r round(children_third_class * 100, 1)`% for third-class children. This represents a class gap of `r round(children_class_gap * 100, 1)` percentage points. Children, like women, were prioritized in evacuation ("women and children first"), yet we still observe a substantial class-based gap in their survival. This gap among children cannot be attributed to gender-based priority rules (which applied equally to all children regardless of class), but rather must reflect either access constraints (physical distance from lifeboats, ability to navigate ship layouts) or differential enforcement of evacuation procedures by class.

---

## 6. Decomposing the Gap: A Conceptual Framework

### 6.1 Overview of the Decomposition Approach

We can conceptually decompose the total class-survival gap into components:

**Total Gap = Gender Composition Effect + Age Composition Effect + Class Access/Treatment Effect**

More precisely:
- **Gender Composition Effect**: The portion of the gap attributable to first-class having more women
- **Age Composition Effect**: The portion of the gap attributable to first-class having more children
- **Class Access/Treatment Effect**: The residual gap that remains after accounting for gender and age composition; this reflects differential access to lifeboats, information, or crew assistance

```{r decomposition_framework}
# Step 1: Calculate expected survival for first-class if it had third-class's gender composition
# Using third-class gender composition and first-class gender-specific survival rates

first_class_data <- train %>% filter(pclass == 1, sex %in% c("male", "female"))
third_class_data <- train %>% filter(pclass == 3, sex %in% c("male", "female"))

# Observed survival rates by gender in first-class
first_class_female_survival <- mean(first_class_data$survived[first_class_data$sex == "female"], na.rm = TRUE)
first_class_male_survival <- mean(first_class_data$survived[first_class_data$sex == "male"], na.rm = TRUE)

# Third-class gender composition
third_class_n <- nrow(third_class_data)
third_class_female_n <- sum(third_class_data$sex == "female")
third_class_male_n <- sum(third_class_data$sex == "male")
third_class_pct_female <- third_class_female_n / third_class_n

# Counterfactual: What if first-class had third-class's gender composition?
# Expected survival for first-class under third-class gender composition
first_class_expected_under_third_class_gender <- (
  third_class_pct_female * first_class_female_survival +
  (1 - third_class_pct_female) * first_class_male_survival
)

# Gender composition effect
gender_composition_effect <- first_class_rate - first_class_expected_under_third_class_gender

# Observed third-class survival
third_class_observed <- third_class_rate

# Remaining gap (unexplained by gender composition)
remaining_gap <- first_class_expected_under_third_class_gender - third_class_observed

# Summary table
decomp_summary <- data.frame(
  Component = c(
    "First-class observed survival",
    "First-class expected (if had third-class gender mix)",
    "Gender composition effect",
    "Third-class observed survival",
    "Remaining gap (after gender composition)"
  ),
  Rate = c(
    first_class_rate,
    first_class_expected_under_third_class_gender,
    gender_composition_effect,
    third_class_observed,
    remaining_gap
  )
)

decomp_summary |> 
  mutate(Rate = paste0(round(Rate * 100, 1), "%")) |>
  kable()

# Calculate proportions of total gap
total_gap_size <- first_class_rate - third_class_rate
gender_effect_share <- gender_composition_effect / total_gap_size * 100
remaining_share <- remaining_gap / total_gap_size * 100
```

**Narrative:** This decomposition technique isolates the gender composition effect from the class access/treatment effect. We calculate what first-class's survival rate would have been *if* it had third-class's gender composition, while retaining first-class's gender-specific survival rates. The difference between first-class's observed rate and this counterfactual represents the gender composition effect, while the difference between the counterfactual and third-class's observed rate represents the remaining gap unexplained by gender composition.

The results show that gender composition accounts for approximately `r round(gender_effect_share, 1)`% of the total class-survival gap. The remaining `r round(remaining_share, 1)`% of the gap—from `r round(first_class_expected_under_third_class_gender * 100, 1)`% to `r round(third_class_observed * 100, 1)`%—cannot be explained by compositional differences and instead reflects class-based access or treatment differences.

### 6.2 Visualizing the Decomposition

```{r plot_decomposition}
# Create a waterfall-style visualization of the gap decomposition
decomp_data <- data.frame(
  stage = c(
    "1st Class\nObserved",
    "Gender\nComposition",
    "1st Class\n(3rd-class gender)",
    "Access &\nConstraints",
    "3rd Class\nObserved"
  ),
  value = c(
    first_class_rate,
    -gender_composition_effect,
    first_class_expected_under_third_class_gender,
    -remaining_gap,
    third_class_rate
  ),
  group = c("First-class", "Effect", "Counterfactual", "Effect", "Third-class")
)

# Cumulative for positioning
decomp_data <- decomp_data %>%
  mutate(
    cumulative = cumsum(value),
    start = lag(cumulative, default = 0)
  )

decomp_plot <- decomp_data %>%
  ggplot(aes(x = factor(stage, levels = stage), y = value, fill = group)) +
  geom_col(color = "black", linewidth = 0.5, alpha = 0.8) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "Set2", guide = "none") +
  labs(
    title = "Decomposition of Class-Survival Gap",
    subtitle = "Separating gender composition effects from access/constraint effects",
    x = "",
    y = "Survival Rate (or Effect Size)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray40"),
    axis.title = element_text(size = 10),
    panel.grid.major.y = element_line(color = "gray90")
  )

print(decomp_plot)
```

**Narrative:** This chart visualizes the decomposition path, moving from first-class's observed survival rate through the gender composition adjustment to a counterfactual, then down to third-class's observed rate. The height of the "gender composition" bar shows the magnitude of the compositional effect, while the "access and constraints" bar shows the remaining unexplained gap. This visualization makes clear that even after accounting for first-class's higher proportion of women, a substantial gap remains, indicating that class-based access or treatment differences are important.

---

## 7. Logistic Regression Analysis: Quantifying Mechanism Contributions

```{r logistic_models}
# Prepare data for regression (remove rows with missing key variables)
regression_data <- train %>%
  filter(!is.na(survived), !is.na(sex)) %>%
  mutate(
    pclass = as.factor(pclass),
    sex_male = as.numeric(sex == "male"),
    pclass_1 = as.numeric(pclass == 1),
    pclass_2 = as.numeric(pclass == 2)
  )

# Model 1: Survival ~ Class only
model1 <- glm(survived ~ pclass, family = binomial(link = "logit"), data = regression_data)

# Model 2: Survival ~ Class + Sex
model2 <- glm(survived ~ pclass + sex, family = binomial(link = "logit"), data = regression_data)

# Model 3: Survival ~ Class + Sex + Age (using only complete age cases)
regression_data_with_age <- regression_data %>% filter(!is.na(age))
model3 <- glm(survived ~ pclass + sex + age, family = binomial(link = "logit"), data = regression_data_with_age)

# Summary of models
cat("=== MODEL 1: Class Only ===\n")
print(summary(model1))

cat("\n=== MODEL 2: Class + Sex ===\n")
print(summary(model2))

cat("\n=== MODEL 3: Class + Sex + Age ===\n")
print(summary(model3))
```

**Narrative:** We fit three logistic regression models with increasing complexity to isolate the class effect. Model 1 estimates the raw class effect on survival probability. Model 2 adds sex as a predictor, allowing us to see how much the class coefficients change when we account for gender differences. Model 3 further adds age. The key insight is the *change in class coefficients* across models: if coefficients change substantially when we add sex, it indicates that gender composition is confounding the class effect. If coefficients remain stable after adding sex, it indicates that class effects operate independently of gender.

```{r extract_coefficients}
# Extract and compare key coefficients
coef_comparison <- data.frame(
  Variable = c("pclass2", "pclass3"),
  Model1 = coef(model1)[c("pclass2", "pclass3")],
  Model2 = coef(model2)[c("pclass2", "pclass3")],
  Model3 = coef(model3)[c("pclass2", "pclass3")]
)

rownames(coef_comparison) <- NULL

cat("Class Coefficient Comparison Across Models\n")
cat("(Negative values indicate lower survival probability relative to 1st class)\n\n")
coef_comparison |> 
  mutate(across(starts_with("Model"), ~round(., 3))) |>
  kable()

# Calculate percent change in class coefficients
pclass3_change_m1_to_m2 <- (coef_comparison$Model2[2] - coef_comparison$Model1[2]) / abs(coef_comparison$Model1[2]) * 100
pclass3_change_m2_to_m3 <- (coef_comparison$Model3[2] - coef_comparison$Model2[2]) / abs(coef_comparison$Model2[2]) * 100

cat("\nPercent change in pclass=3 coefficient:\n")
cat("Model 1 to Model 2 (adding sex):", round(pclass3_change_m1_to_m2, 1), "%\n")
cat("Model 2 to Model 3 (adding age):", round(pclass3_change_m2_to_m3, 1), "%\n")
```

**Narrative:** The regression coefficients tell an important story about mechanism. The third-class coefficient (representing the log-odds reduction relative to first class) in Model 1 is `r round(coef_comparison$Model1[2], 3)`. When we add sex in Model 2, this coefficient changes to `r round(coef_comparison$Model2[2], 3)`—a change of approximately `r round(abs(pclass3_change_m1_to_m2), 1)`%. This modest change suggests that gender composition does *not* fully explain the class-survival gap; the class effect remains substantial even after accounting for sex. When we further add age in Model 3, the third-class coefficient becomes `r round(coef_comparison$Model3[2], 3)`, indicating that demographic composition (gender and age) explains only a portion of the class effect, leaving a substantial unexplained class-based gap.

```{r predicted_probabilities}
# Calculate predicted survival probabilities for key combinations
pred_data <- expand.grid(
  pclass = factor(1:3, levels = 1:3),
  sex = c("male", "female"),
  age = median(regression_data_with_age$age, na.rm = TRUE)
)

pred_data$pred_prob_model2 <- predict(model2, newdata = pred_data, type = "response")
pred_data$pred_prob_model3 <- predict(model3, newdata = pred_data, type = "response")

# Create labels for display
pred_data_display <- pred_data %>%
  mutate(
    class_label = factor(pclass, levels = 1:3, labels = c("1st Class", "2nd Class", "3rd Class"))
  )

cat("Predicted Survival Probabilities (Model 3: Class + Sex + Age)\n")
cat("(Age fixed at median =", median(regression_data_with_age$age, na.rm = TRUE), ")\n\n")
pred_data_display |> 
  select(class_label, sex, pred_prob_model3) |>
  mutate(pred_prob_model3 = paste0(round(pred_prob_model3 * 100, 1), "%")) |>
  rename("Class" = class_label, "Gender" = sex, "Predicted Survival %" = pred_prob_model3) |>
  kable()

# Class gap for women (Model 3)
women_pred <- pred_data_display %>% filter(sex == "female")
women_class_gap_model <- women_pred$pred_prob_model3[women_pred$class_label == "1st Class"] - 
                         women_pred$pred_prob_model3[women_pred$class_label == "3rd Class"]
```

**Narrative:** The predicted probabilities from Model 3 show that even after accounting for gender and age, first-class women have a predicted survival probability of `r round(women_pred$pred_prob_model3[women_pred$pclass == "1st Class"] * 100, 1)`%, while third-class women have `r round(women_pred$pred_prob_model3[women_pred$pclass == "3rd Class"] * 100, 1)`%—a gap of `r round(women_class_gap_model * 100, 1)` percentage points. This residual gap after accounting for demographic variables suggests that class-based differences in access to lifeboats or evacuation information played a real role.

---

## 8. Summary and Interpretation

### 8.1 Key Findings

1. **Raw Class-Survival Gap**: First-class passengers had a survival rate of `r round(first_class_rate * 100, 1)`% versus `r round(third_class_rate * 100, 1)`% for third-class, an absolute difference of `r round(absolute_gap * 100, 1)` percentage points.

2. **Gender Composition Effect**: Approximately `r round(gender_effect_share, 1)`% of the total gap is attributable to first-class having a higher proportion of female passengers. The remaining `r round(remaining_share, 1)`% cannot be explained by compositional differences alone.

3. **Stratified Gaps**:
   - **Women only**: `r round(women_class_gap * 100, 1)` pp gap between first and third class
   - **Men only**: `r round(men_class_gap * 100, 1)` pp gap between first and third class
   - **Children only**: `r round(children_class_gap * 100, 1)` pp gap between first and third class

4. **Regression Results**: Class coefficients remain large and significant even after accounting for gender and age, indicating that demographic composition explains only part of the class-survival relationship.

### 8.2 Interpretation: Access and Constraints vs. Priority Rules

The analysis suggests a decomposition of the class-survival gap into:

- **Priority Rule Effects** (Gender-based): The "women and children first" protocol appears to have been applied relatively uniformly across classes. The gender composition effect (`r round(gender_effect_share, 1)`% of the total gap) reflects the fact that first-class had more women, who benefited from this rule.

- **Access and Constraint Effects** (Class-based): The residual gap of `r round(remaining_share, 1)` percentage points (`r round(remaining_share, 1)`% of the total) suggests that class-based physical access, information dissemination, or crew assistance differed materially. This includes:
  - Proximity to lifeboats (1st-class cabins on upper decks, closer to boat deck)
  - Information barriers (3rd-class passengers may not have learned of evacuation quickly)
  - Institutional constraints (gates separating classes may have delayed 3rd-class evacuation)

### 8.3 Considerations and Limitations

- **Incomplete Age Data**: Our analysis of age effects uses only the `r nrow(regression_data_with_age)` passengers with non-missing age values. Age composition may be more important than our regression analysis suggests.
- **Information and Behavior**: The data cannot directly measure how quickly information spread or how crews treated different classes, but the residual gap suggests these factors mattered.
- **Confounding by Other Variables**: Variables like family structure (`sibsp`, `parch`) and fare may mediate or confound the class effect and warrant further investigation.

### 8.4 Conclusion

This analysis provides a structured framework for decomposing the class-survival gap into components attributable to different mechanisms. The evidence suggests that:

1. Gender-based priority rules contributed to the overall class gap primarily through compositional effects (first-class had more women).
2. Class-based access or treatment differences appear to account for the majority of the residual gap (approximately `r round(remaining_share, 1)`% of the total).
3. The gap persists even within demographic subgroups (women-only, men-only, children-only), suggesting that class-based mechanisms operated independently of gender-based priority rules.

The next analytical steps would involve deeper investigation of the specific mechanisms (physical access, information dissemination, crew allocation) that created these class-based disparities.

---

## References and Notes

- Data source: Titanic dataset (training set from Kaggle competition)
- Analysis date: `r Sys.Date()`
- All calculations are reproducible from the provided .qmd code
