---
title: "Titanic Survival Analysis: Gender, SES, and Age"
author: "CLI Copilot"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    self-contained: true
execute:
  echo: true
  warning: false
  message: false
---


```{r}
# Load libraries
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(forcats)
library(knitr)
library(broom)

# Set minimalist theme
theme_set(theme_minimal(base_size = 13))
update_geom_defaults("point", list(alpha = 0.8))
```

# Data loading and preparation

```{r}
train <- read_csv("data/train.csv", show_col_types = FALSE)
# Basic cleaning and feature engineering

titanic <- train %>%
  mutate(
    Survived = factor(Survived, levels = c(0,1), labels = c("Died","Survived")),
    Sex = factor(Sex),
    Pclass = factor(Pclass, levels = c(1,2,3), labels = c("1st","2nd","3rd")),
    Embarked = fct_explicit_na(Embarked, na_level = "Unknown"),
    # Family structure: SibSp + Parch + 1 (self)
    FamilySize = SibSp + Parch + 1,
    FamilyStructure = case_when(
      FamilySize == 1 ~ "Solo",
      FamilySize >= 2 & FamilySize <= 4 ~ "Small",
      FamilySize >= 5 ~ "Large"
    ),
    FamilyStructure = factor(FamilyStructure, levels = c("Solo","Small","Large")),
    # Age handling: create age groups with an Unknown bucket
    AgeGroup = case_when(
      is.na(Age) ~ "Unknown",
      Age < 12 ~ "Child";
      Age >= 12 & Age < 18 ~ "Teen",
      Age >= 18 & Age < 30 ~ "YoungAdult",
      Age >= 30 & Age < 50 ~ "Adult",
      Age >= 50 ~ "Senior"
    ),
    AgeGroup = factor(AgeGroup, levels = c("Child","Teen","YoungAdult","Adult","Senior","Unknown"))
  ) %>%
  mutate(
    SES = fct_recode(Pclass, "High" = "1st", "Mid" = "2nd", "Low" = "3rd")
  )

# Quick sanity checks
kable(titanic %>% select(Survived, Sex, SES, Age, AgeGroup, FamilyStructure, Embarked) %>% head())
```

# Research Question 1: Joint effects of gender and SES on survival, with age, family structure, and embarkation

We model survival using logistic regression with main effects and interactions between Gender and SES. Age, FamilyStructure, and Embarked are included as covariates to assess mediation/attenuation.

```{r}
# Fit logistic regression
# Note: Use complete cases for numeric age to avoid model issues, but keep AgeGroup for categorical summaries.
model_df <- titanic %>% 
  mutate(SurvivedBin = as.integer(Survived == "Survived")) %>%
  select(SurvivedBin, Sex, SES, Age, FamilyStructure, Embarked) %>%
  drop_na(Sex, SES, FamilyStructure, Embarked) # allow Age to be NA; glm will drop rows where Age is NA automatically

fit <- glm(SurvivedBin ~ Sex * SES + Age + FamilyStructure + Embarked, 
           data = model_df, family = binomial())
summary_fit <- broom::tidy(fit, conf.int = TRUE, exponentiate = TRUE)

kable(summary_fit, digits = 3, caption = "Logistic regression (odds ratios) for survival")
```

Interpretation notes:
- Odds ratios > 1 indicate higher survival odds.
- Interaction terms (Sex:SES) show how the gender effect differs by SES levels.
- If adding Age, FamilyStructure, and Embarked reduces the magnitude of Sex/SES effects, this suggests partial mediation/attenuation.

```{r}
# Compare a simpler model (Sex + SES only) vs full model to assess attenuation
fit_simple <- glm(SurvivedBin ~ Sex + SES, data = model_df, family = binomial())
fit_full   <- glm(SurvivedBin ~ Sex * SES + Age + FamilyStructure + Embarked, data = model_df, family = binomial())

comp <- bind_rows(
  tidy(fit_simple, conf.int = TRUE, exponentiate = TRUE) %>% mutate(model = "Simple"),
  tidy(fit_full,   conf.int = TRUE, exponentiate = TRUE) %>% mutate(model = "Full")
) %>% filter(term %in% c("Sexmale","SESMid","SESLow","Sexmale:SESMid","Sexmale:SESLow"))

kable(comp, digits = 3, caption = "Key effects comparison (ORs): Simple vs Full model")
```

```{r}
# Visualization: Predicted survival by Sex and SES, averaged over covariates
newdata <- titanic %>% 
  summarize(
    Age = mean(Age, na.rm = TRUE),
    FamilyStructure = names(which.max(table(FamilyStructure))),
    Embarked = names(which.max(table(Embarked)))
  )

pred_grid <- expand_grid(Sex = levels(titanic$Sex), SES = levels(titanic$SES)) %>%
  mutate(Age = newdata$Age,
         FamilyStructure = factor(newdata$FamilyStructure, levels = levels(titanic$FamilyStructure)),
         Embarked = factor(newdata$Embarked, levels = levels(titanic$Embarked)))

pred <- pred_grid %>% mutate(
  pred_prob = plogis(predict(fit_full, newdata = pred_grid))
)

ggplot(pred, aes(SES, pred_prob, color = Sex, group = Sex)) +
  geom_point(size = 3) +
  geom_line() +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Predicted survival by Gender and SES",
       x = "Socioeconomic status (Pclass)", y = "Predicted survival probability",
       color = "Gender") +
  theme(legend.position = "bottom")
```

# Research Question 2: Which age group is at the highest risk?

```{r}
# Survival rate by age group
age_surv <- titanic %>%
  group_by(AgeGroup) %>%
  summarize(n = n(), surv_rate = mean(Survived == "Survived"), .groups = "drop") %>%
  arrange(surv_rate)

kable(age_surv, digits = 3, caption = "Survival rate by age group (lower = higher risk)")

ggplot(age_surv, aes(fct_reorder(AgeGroup, surv_rate), surv_rate, fill = AgeGroup)) +
  geom_col() +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Survival probability by age group",
       x = "Age group (ordered by survival)", y = "Survival probability",
       fill = "Age group") +
  theme(legend.position = "bottom")
```

Interpretation:
- The age group with the lowest survival probability is the highest risk group.
- Note the Unknown group may reflect missing data; interpret cautiously.

# Research Question 3: Safety suggestion

Based on typical Titanic patterns, survival odds are much higher for females and higher SES, and are influenced by age, family structure, and embarkation. Policy recommendations include:
- Enforce and drill clear evacuation prioritization independent of ticket class, emphasizing equitable access to lifeboats for low SES passengers.
- Increase lifeboat capacity and ensure distribution accessible to all decks.
- Targeted assistance for seniors and solo travelers who show lower survival rates.
- Staff training and signage tailored to ports of embarkation demographics to reduce confusion.

# Appendix: Model diagnostics (brief)

```{r}
# Basic goodness-of-fit comparison
AIC(fit_simple); AIC(fit_full)

# Check pseudo-R2
pseudo_r2 <- 1 - (fit_full$deviance / fit_full$null.deviance)
pseudo_r2
```
