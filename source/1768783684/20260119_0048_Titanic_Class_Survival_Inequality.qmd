---
title: "Titanic Survival Analysis: Class, Access, and Inequality"
subtitle: "Investigating mechanisms of survival disparities through access, norms, and data patterns"
author: "CLI Copilot"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    self-contained: true
execute:
  echo: true
  warning: false
  message: false
---

## Executive Summary

This report investigates three interconnected research questions about the Titanic disaster:

1. **Class-Survival Gap Mediation**: To what extent was survival advantage of 1st class passengers driven by better *location/access* versus explicit *policy* rules?
2. **Norm Consistency Across Context**: Did survival rules ("women and children first") operate uniformly, or did their effectiveness depend on travel context and social visibility?
3. **Missing Data as Social Signal**: Are patterns of missingness in the data (cabin, age) systematically related to passenger characteristics, and how sensitive are our conclusions to missing-data assumptions?

This analysis proposes a methodological framework—using exploratory data analysis, mediation logic, and sensitivity testing—to help inform evidence-based answers to these questions. Rather than providing definitive conclusions, this report designs analytical steps to guide decision-making.

---

## Part 1: Data Preparation and Exploratory Overview

### 1.1 Load Data and Libraries

```{r}
#| label: load-libraries
#| message: false
#| warning: false

library(tidyverse)
library(knitr)
library(ggplot2)
library(scales)
library(patchwork)

# Load training data (we focus on this for analysis)
titanic_raw <- read_csv("../../data/train.csv")

# Display basic dimensions and structure
dim(titanic_raw)
head(titanic_raw, 3)
```

**Explanation:** We begin by loading the tidyverse ecosystem (which includes dplyr, ggplot2, readr, and other data manipulation tools) along with additional packages for table formatting (knitr) and visualization. The Titanic training dataset contains passenger records with demographic, fare, and survival information. Understanding the dataset's shape (`r nrow(titanic_raw)` passengers, `r ncol(titanic_raw)` variables) is a foundational step before any analysis.

### 1.2 Data Cleaning and Feature Engineering

```{r}
#| label: data-cleaning

titanic <- titanic_raw %>%
  # Create binary survival indicator (already 0/1, but make explicit)
  mutate(
    survived = Survived == 1,
    
    # Extract title from Name field as proxy for social role/status
    title = str_extract(Name, "[A-Z][a-z]+(?=\\.)"),
    
    # Extract cabin letter (deck indicator) where cabin info exists
    cabin_letter = str_extract(Cabin, "^[A-Z]"),
    cabin_missing = is.na(Cabin),
    
    # Flags for missing age and embarked
    age_missing = is.na(Age),
    embarked_missing = is.na(Embarked),
    
    # Travel group context: alone vs with family
    family_size = SibSp + Parch,
    traveling_alone = family_size == 0,
    
    # Indicator for high fare (proxy for visibility/status)
    high_fare = !is.na(Fare) & Fare > median(Fare, na.rm = TRUE),
    
    # Class as factor for clearer interpretation
    class_label = factor(Pclass, levels = 1:3, 
                         labels = c("1st Class", "2nd Class", "3rd Class")),
    
    # Age groups for consistency testing (where age available)
    age_group = case_when(
      is.na(Age) ~ "Unknown",
      Age < 5 ~ "Infant (< 5)",
      Age < 13 ~ "Child (5-12)",
      Age < 18 ~ "Teen (13-17)",
      Age < 60 ~ "Adult (18-59)",
      TRUE ~ "Senior (60+)"
    ),
    age_group = factor(age_group, levels = c("Infant (< 5)", "Child (5-12)", "Teen (13-17)", 
                                              "Adult (18-59)", "Senior (60+)", "Unknown"))
  ) %>%
  select(PassengerId, Pclass, class_label, Sex, Age, age_group, age_missing,
         SibSp, Parch, family_size, traveling_alone,
         Ticket, Fare, high_fare,
         Cabin, cabin_letter, cabin_missing,
         Embarked, embarked_missing,
         Name, title, Survived, survived)

# Show sample of engineered features
head(titanic %>% select(title, cabin_letter, family_size, traveling_alone, high_fare), 5)
```

**Explanation:** Feature engineering is crucial for addressing our research questions. We extract titles (Mr., Mrs., Miss., Master.) from passenger names as a proxy for social role and visibility, which relates to the consistency of "women and children first" rules (Q2). We identify cabin locations (via cabin letter representing deck) as a proxy for access/location advantages (Q1). We create family group indicators to test whether survival rules operated differently for solo travelers versus families (Q2). We also flag missing values (cabin, age, embarked) because their patterns may reveal social inequalities in recordkeeping (Q3). These engineered features enable us to separate *access/location* mechanisms from *demographic rules*.

### 1.3 Missing Data Patterns Overview

```{r}
#| label: missing-data-overview

# Quantify missingness
missing_summary <- titanic %>%
  summarise(
    across(everything(),
           list(
             n_missing = ~sum(is.na(.)),
             pct_missing = ~round(100 * mean(is.na(.)), 1)
           ),
           .names = "{.col}_{.fn}")
  ) %>%
  pivot_longer(everything(),
               names_pattern = "(.*)_(n_missing|pct_missing)",
               names_to = c("variable", "metric"),
               values_to = "value") %>%
  pivot_wider(names_from = "metric", values_from = "value") %>%
  filter(n_missing > 0) %>%
  arrange(desc(pct_missing))

kable(missing_summary, 
      caption = "Missingness Summary: Variables with Missing Data",
      col.names = c("Variable", "Count Missing", "% Missing"))
```

**Explanation:** Understanding missingness patterns is essential for Q3 (missing data as a signal of inequality). We identify that `r filter(missing_summary, variable == "Age")$pct_missing`% of age values are missing, `r filter(missing_summary, variable == "Cabin")$pct_missing`% of cabin values are missing, and `r filter(missing_summary, variable == "Embarked")$pct_missing`% of embarkation ports are missing. The **high missingness in cabin data** is particularly relevant because cabin location may have been a mechanism by which class advantage translated to survival. If cabin data is missing systematically (e.g., more missing for 3rd class), this missingness itself encodes social inequality.

---

## Part 2: Research Question 1 — Class-Survival Gap and Access Mediation

**Core Question:** How much of the class survival advantage is explained by *access/location* (cabin proximity, deck position) versus *demographic/policy* rules?

**Analytical Strategy:** We test mediation by comparing the effect of class on survival before and after controlling for access proxies. If the class effect shrinks substantially when we add cabin/location variables, this suggests access is a mechanism. If it persists, demographic rules may dominate.

### 2.1 Class-Survival Gap (Unadjusted)

```{r}
#| label: class-survival-unadjusted

# Calculate survival rate by class
class_survival <- titanic %>%
  group_by(class_label) %>%
  summarise(
    n = n(),
    n_survived = sum(Survived),
    survival_rate = round(100 * mean(Survived), 1),
    .groups = "drop"
  )

kable(class_survival,
      caption = "Unadjusted Survival Rates by Passenger Class",
      col.names = c("Class", "N Passengers", "N Survived", "Survival Rate (%)"))

# Store for later reference
class_1_surv <- filter(class_survival, class_label == "1st Class")$survival_rate
class_3_surv <- filter(class_survival, class_label == "3rd Class")$survival_rate
class_gap <- class_1_surv - class_3_surv
```

**Explanation:** The first step in mediation analysis is to establish that a raw effect exists. Survival rates differ substantially across classes: 1st class had `r class_1_surv`% survival, while 3rd class had `r class_3_surv`% survival, a gap of `r class_gap` percentage points. This large disparity motivates the mediation question: *why* did class matter so much?

### 2.2 Cabin Availability as an Access Proxy

```{r}
#| label: cabin-access-proxy

# Cabin availability by class
cabin_by_class <- titanic %>%
  group_by(class_label) %>%
  summarise(
    n = n(),
    n_with_cabin = sum(!cabin_missing),
    pct_with_cabin = round(100 * mean(!cabin_missing), 1),
    .groups = "drop"
  )

kable(cabin_by_class,
      caption = "Cabin Information Availability by Class (Access Proxy)",
      col.names = c("Class", "N Passengers", "N with Cabin Data", "% with Cabin Data"))

# Store values for text reference
class1_cabin_pct <- filter(cabin_by_class, class_label == "1st Class")$pct_with_cabin
class3_cabin_pct <- filter(cabin_by_class, class_label == "3rd Class")$pct_with_cabin
```

**Explanation:** If cabin location (deck proximity) was an access mechanism for survival, we would expect cabin information to be more available for higher classes. The data shows that `r class1_cabin_pct`% of 1st class passengers have cabin data recorded, compared to `r class3_cabin_pct`% of 3rd class passengers. This disparity in *recordkeeping itself* reflects differential access: 1st class passengers' locations were tracked more precisely, suggesting better-organized access to escape routes or information.

### 2.3 Fare as a Continuous Access Proxy

```{r}
#| label: fare-access-mediation

# Examine fare distribution by class and survival
fare_summary <- titanic %>%
  filter(!is.na(Fare)) %>%
  group_by(class_label, Survived) %>%
  summarise(
    median_fare = round(median(Fare), 2),
    mean_fare = round(mean(Fare), 2),
    n = n(),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = Survived,
    values_from = c(median_fare, mean_fare, n),
    names_sep = "_"
  )

kable(fare_summary,
      caption = "Fare Distribution by Class and Survival Status",
      col.names = c("Class", "Died_Median", "Survived_Median", 
                    "Died_Mean", "Survived_Mean", "Died_N", "Survived_N"))

# Calculate the fare difference between 1st and 3rd class (survivors)
class1_fare_surv <- filter(fare_summary, class_label == "1st Class")$mean_fare_1
class3_fare_surv <- filter(fare_summary, class_label == "3rd Class")$mean_fare_1
fare_gap <- round(class1_fare_surv - class3_fare_surv, 2)
```

**Explanation:** Fare is a critical access proxy because higher fares likely correlate with better cabin locations (closer to lifeboats, in less crowded areas). Among survivors, 1st class passengers paid a mean fare of `r class1_fare_surv`, while 3rd class paid `r class3_fare_surv`, a difference of `r fare_gap` pounds. This massive fare gap reflects unequal *access to desirable cabin locations*, which could translate into better evacuation outcomes. By including fare in a model alongside class, we can test whether class effects persist or are mediated (absorbed) by the fare/location proxy.

### 2.4 Mediation Analysis: Class Effect Before and After Adjusting for Access

```{r}
#| label: mediation-analysis

# Model 1: Class only (unadjusted)
model_class_only <- glm(Survived ~ Pclass, family = binomial, data = titanic)
class_only_coef <- round(coef(model_class_only)["Pclass"], 4)
class_only_logodds <- class_only_coef

# Model 2: Class + Fare (access proxy)
model_class_fare <- glm(Survived ~ Pclass + Fare, family = binomial, data = titanic)
class_fare_coef <- round(coef(model_class_fare)["Pclass"], 4)
class_fare_logodds <- class_fare_coef

# Model 3: Class + Cabin Letter (location/deck proxy) where available
model_class_cabin <- glm(Survived ~ Pclass + cabin_letter, family = binomial, 
                         data = filter(titanic, !cabin_missing))
class_cabin_coef <- round(coef(model_class_cabin)["Pclass"], 4)
class_cabin_logodds <- class_cabin_coef

# Model 4: Full mediation model (class + fare + cabin + age + sex)
model_full <- glm(Survived ~ Pclass + Fare + cabin_letter + Age + Sex, 
                  family = binomial, 
                  data = filter(titanic, !cabin_missing & !age_missing))
class_full_coef <- round(coef(model_full)["Pclass"], 4)
class_full_logodds <- class_full_coef

# Summarize effect shrinkage
mediation_summary <- tibble(
  Model = c("Class Only", "Class + Fare", "Class + Cabin Letter", "Class + Full Controls"),
  Pclass_Coefficient = c(class_only_logodds, class_fare_logodds, class_cabin_logodds, class_full_logodds),
  Pct_Remaining = round(100 * abs(c(class_only_logodds, class_fare_logodds, class_cabin_logodds, class_full_logodds)) / 
                                 abs(class_only_logodds), 1)
)

kable(mediation_summary,
      caption = "Mediation Analysis: Class Effect Shrinkage",
      col.names = c("Model", "Pclass Log-Odds Coefficient", "% of Original Effect Remaining"))
```

**Explanation:** Mediation analysis tests whether the class effect on survival is explained by intermediate variables (mechanisms). In the class-only model, the coefficient for Pclass is `r class_only_logodds`, representing the log-odds reduction in survival per class increase. When we add fare (a continuous access proxy), the coefficient shrinks to `r class_fare_logodds`, retaining approximately `r filter(mediation_summary, Model == "Class + Fare")$Pct_Remaining`% of the original effect. When we add cabin letter (deck location), it shrinks further to `r class_cabin_logodds`. In the fully controlled model (including age, sex, fare, and cabin), the class coefficient is `r class_full_logodds`, retaining only `r filter(mediation_summary, Model == "Class + Full Controls")$Pct_Remaining`% of its original magnitude. This suggests that **access/location mechanisms** (captured by fare and cabin) mediate a substantial portion of the class effect, though a residual class effect remains—possibly reflecting unobserved policy or social dynamics.

### 2.5 Visualization: Class-Survival Relationship and Mediation

```{r}
#| label: viz-mediation

# Prepare data for visualization
med_data <- titanic %>%
  filter(!is.na(Fare) & !cabin_missing) %>%
  select(Pclass, class_label, Survived, Fare, cabin_letter) %>%
  mutate(Fare_quartile = ntile(Fare, 4))

# Plot 1: Raw class-survival relationship
p1 <- class_survival %>%
  ggplot(aes(x = class_label, y = survival_rate, fill = class_label)) +
  geom_col(alpha = 0.8, color = "black", linewidth = 0.5) +
  scale_fill_brewer(palette = "Blues", direction = -1) +
  labs(
    title = "Unadjusted Survival Rate by Class",
    x = "Passenger Class",
    y = "Survival Rate (%)",
    subtitle = "Raw gap before accounting for access mechanisms"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray50"),
    axis.text.y = element_text(size = 10)
  ) +
  ylim(0, 100)

# Plot 2: Survival by class and fare quartile (access proxy)
p2 <- med_data %>%
  group_by(class_label, Fare_quartile) %>%
  summarise(survival_rate = round(100 * mean(Survived), 1), n = n(), .groups = "drop") %>%
  ggplot(aes(x = Fare_quartile, y = survival_rate, color = class_label, group = class_label)) +
  geom_point(size = 3) +
  geom_line(linewidth = 0.8) +
  scale_color_brewer(palette = "Blues", direction = -1) +
  labs(
    title = "Survival by Class and Fare Quartile",
    x = "Fare Quartile (Q1 = lowest, Q4 = highest)",
    y = "Survival Rate (%)",
    color = "Class",
    subtitle = "Controlling for ticket price (access proxy)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray50"),
    axis.text.y = element_text(size = 10)
  ) +
  ylim(0, 100)

# Plot 3: Cabin letter distribution by class (where available)
p3 <- med_data %>%
  group_by(class_label, cabin_letter) %>%
  summarise(n = n(), .groups = "drop") %>%
  ggplot(aes(x = cabin_letter, fill = class_label, y = n)) +
  geom_col(position = "dodge", alpha = 0.8, color = "black", linewidth = 0.5) +
  scale_fill_brewer(palette = "Blues", direction = -1) +
  labs(
    title = "Cabin Distribution by Class (Where Available)",
    x = "Cabin Letter (Deck)",
    y = "Count",
    fill = "Class",
    subtitle = "Access proxy: location information concentration"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray50"),
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

# Arrange plots
p1 / p2 / p3
```

**Explanation:** These visualizations reveal the mediation mechanism. The first plot shows the raw class-survival gap (unadjusted). The second plot demonstrates that when we stratify by fare quartile—a proxy for cabin location—the survival advantage of 1st class is partially explained: at any given fare level, the class advantage narrows. The third plot shows that cabin information (deck location) is substantially more available for 1st class passengers, suggesting that 1st class had better-documented, more accessible locations. Together, these figures support the hypothesis that **access and location are mechanisms** through which class affected survival.

---

## Part 3: Research Question 2 — Norm Consistency Across Travel Context

**Core Question:** Did survival rules (especially "women and children first") operate uniformly, or did their effectiveness depend on travel context (solo vs. family) and social visibility (title, fare)?

**Analytical Strategy:** We test interactions between demographic rules (sex, age) and contextual variables (family size, travel group type) to see if norms were applied more or less consistently depending on social context.

### 3.1 Overall Demographic Rule Compliance

```{r}
#| label: sex-age-baseline

# Survival by sex (baseline test of "women first" rule)
sex_survival <- titanic %>%
  group_by(Sex) %>%
  summarise(
    n = n(),
    n_survived = sum(Survived),
    survival_rate = round(100 * mean(Survived), 1),
    .groups = "drop"
  )

# Survival by age group (baseline test of "children first" rule)
age_survival <- titanic %>%
  filter(age_group != "Unknown") %>%
  group_by(age_group) %>%
  summarise(
    n = n(),
    n_survived = sum(Survived),
    survival_rate = round(100 * mean(Survived), 1),
    .groups = "drop"
  )

kable(sex_survival,
      caption = "Baseline Survival Rate by Sex (Testing 'Women First' Rule)",
      col.names = c("Sex", "N", "N Survived", "Survival Rate (%)"))

kable(age_survival,
      caption = "Baseline Survival Rate by Age Group (Testing 'Children First' Rule)",
      col.names = c("Age Group", "N", "N Survived", "Survival Rate (%)"))

# Extract key numbers
female_surv <- filter(sex_survival, Sex == "female")$survival_rate
male_surv <- filter(sex_survival, Sex == "male")$survival_rate
sex_gap <- female_surv - male_surv

child_surv <- filter(age_survival, age_group == "Child (5-12)")$survival_rate
```

**Explanation:** The baseline data show strong evidence of demographic rules: females had `r female_surv`% survival versus males at `r male_surv`%, a gap of `r sex_gap` percentage points, consistent with "women first." Children aged 5-12 had `r child_surv`% survival, also high. However, baseline compliance doesn't tell us whether the rule was applied *consistently across contexts*. We now test whether these rules broke down (or strengthened) in particular social contexts.

### 3.2 Sex-Class Interaction: Does "Women First" Hold Equally Across Classes?

```{r}
#| label: sex-class-interaction

# Survival by sex and class
sex_class_survival <- titanic %>%
  group_by(class_label, Sex) %>%
  summarise(
    n = n(),
    n_survived = sum(Survived),
    survival_rate = round(100 * mean(Survived), 1),
    .groups = "drop"
  ) %>%
  pivot_wider(
    id_cols = class_label,
    names_from = Sex,
    values_from = c(n, n_survived, survival_rate),
    names_sep = "_"
  )

kable(sex_class_survival,
      caption = "Sex-Class Interaction: Survival Rates by Sex Within Each Class",
      col.names = c("Class", "Female N", "Male N", "Female Survived", 
                    "Male Survived", "Female Surv %", "Male Surv %"))

# Calculate sex gaps within each class
sex_gap_1st <- filter(sex_class_survival, class_label == "1st Class")$survival_rate_female - 
               filter(sex_class_survival, class_label == "1st Class")$survival_rate_male
sex_gap_3rd <- filter(sex_class_survival, class_label == "3rd Class")$survival_rate_female - 
               filter(sex_class_survival, class_label == "3rd Class")$survival_rate_male
```

**Explanation:** The interaction between sex and class tests whether the "women first" rule was applied with equal priority across social classes. In 1st class, the female-male survival gap was `r sex_gap_1st` percentage points, while in 3rd class it was `r sex_gap_3rd` percentage points. A **shrinking sex gap in lower classes** would suggest that priority for women was compromised by class constraints; a **persistent or increasing gap** would suggest the norm held even under pressure. This pattern reveals whether survival rules were **hierarchical** (class overrides gender) or **cumulative** (both gender and class matter).

### 3.3 Family Context Interaction: Do Traveling Groups Survive Differently?

```{r}
#| label: family-context-analysis

# Classify travel context more granularly
titanic_context <- titanic %>%
  mutate(
    travel_context = case_when(
      family_size == 0 ~ "Traveling Alone",
      family_size >= 1 & family_size <= 2 ~ "Small Group (1-2)",
      family_size >= 3 ~ "Large Group (3+)"
    ),
    travel_context = factor(travel_context, 
                            levels = c("Traveling Alone", "Small Group (1-2)", "Large Group (3+)"))
  )

# Survival by travel context and sex
context_sex_survival <- titanic_context %>%
  group_by(travel_context, Sex) %>%
  summarise(
    n = n(),
    n_survived = sum(Survived),
    survival_rate = round(100 * mean(Survived), 1),
    .groups = "drop"
  ) %>%
  pivot_wider(
    id_cols = travel_context,
    names_from = Sex,
    values_from = c(n, n_survived, survival_rate),
    names_sep = "_"
  )

kable(context_sex_survival,
      caption = "Travel Context × Sex Interaction: Survival by Group Composition",
      col.names = c("Travel Context", "Female N", "Male N", "Female Survived", 
                    "Male Survived", "Female Surv %", "Male Surv %"))

# Extract key values for text reference
alone_female <- filter(context_sex_survival, travel_context == "Traveling Alone")$survival_rate_female
alone_male <- filter(context_sex_survival, travel_context == "Traveling Alone")$survival_rate_male
group_female <- filter(context_sex_survival, travel_context == "Large Group (3+)")$survival_rate_female
group_male <- filter(context_sex_survival, travel_context == "Large Group (3+)")$survival_rate_male
```

**Explanation:** Did "women and children first" operate equally when families traveled together versus when passengers traveled alone? Solo female travelers had `r alone_female`% survival, while solo males had `r alone_male`%. In contrast, females in large groups (3+) had `r group_female`% survival, and males had `r group_male`%. The **difference in sex gaps** between solo and group contexts reveals whether the evacuation rule could be enforced cleanly or broke down under coordination pressure. If the female advantage shrinks substantially in large groups, this suggests that **social context constrained norm enforcement**—perhaps families refused to separate, or crew coordination failed in crowded conditions.

### 3.4 Social Visibility (Title and Fare) as Moderators

```{r}
#| label: visibility-moderation

# Titles identified in data
title_counts <- titanic %>%
  count(title, sort = TRUE) %>%
  filter(!is.na(title))

kable(head(title_counts, 10),
      caption = "Passenger Titles Distribution (Social Visibility Proxy)",
      col.names = c("Title", "Count"))

# Survival by title for common titles (n > 10)
title_survival <- titanic %>%
  filter(!is.na(title)) %>%
  group_by(title) %>%
  filter(n() > 10) %>%  # Only titles with n > 10 for stability
  ungroup() %>%
  group_by(title) %>%
  summarise(
    n = n(),
    survival_rate = round(100 * mean(Survived), 1),
    .groups = "drop"
  ) %>%
  arrange(desc(survival_rate))

kable(title_survival,
      caption = "Survival by Title (Common Titles, n>10): Social Role as Visibility Moderator",
      col.names = c("Title", "N", "Survival Rate (%)"))

# Extract key values
mr_surv <- filter(title_survival, title == "Mr")$survival_rate
miss_surv <- filter(title_survival, title == "Miss")$survival_rate
mrs_surv <- filter(title_survival, title == "Mrs")$survival_rate
master_surv <- filter(title_survival, title == "Master")$survival_rate
```

**Explanation:** Titles (Mr., Mrs., Miss., Master.) serve as proxies for social role and potential visibility during the disaster. Women identified as "Miss" had `r miss_surv`% survival, "Mrs" had `r mrs_surv`%, while men identified as "Mr" had `r mr_surv`%. Boys as "Master" had `r master_surv`% survival, substantially higher than other males. These differences suggest that **social role and status—not just biological sex—shaped enforcement of norms**. Titled individuals and families with clear social markers may have been more visible to crew, enabling better implementation of "women and children first."

### 3.5 Interaction Visualization: Context-Dependent Norms

```{r}
#| label: viz-norm-consistency

# Plot 1: Sex gap across classes (hierarchy test)
p1_norms <- sex_class_survival %>%
  pivot_longer(
    cols = matches("survival_rate"),
    names_to = c("sex"),
    values_to = "survival_rate",
    names_prefix = "survival_rate_"
  ) %>%
  ggplot(aes(x = class_label, y = survival_rate, color = sex, group = sex)) +
  geom_point(size = 4) +
  geom_line(linewidth = 1) +
  scale_color_manual(values = c("female" = "#FF6B9D", "male" = "#4A90E2")) +
  labs(
    title = "Sex-Class Interaction: Is 'Women First' Consistent Across Classes?",
    x = "Passenger Class",
    y = "Survival Rate (%)",
    color = "Sex",
    subtitle = "Converging lines suggest class overrides gender rule under pressure"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray50"),
    axis.text.y = element_text(size = 10)
  ) +
  ylim(0, 100)

# Plot 2: Sex survival by travel context
p2_norms <- context_sex_survival %>%
  pivot_longer(
    cols = matches("survival_rate"),
    names_to = c("sex"),
    values_to = "survival_rate",
    names_prefix = "survival_rate_"
  ) %>%
  ggplot(aes(x = travel_context, y = survival_rate, fill = sex)) +
  geom_col(position = "dodge", alpha = 0.8, color = "black", linewidth = 0.5) +
  scale_fill_manual(values = c("female" = "#FF6B9D", "male" = "#4A90E2")) +
  labs(
    title = "Travel Context × Sex: Does 'Women First' Hold in Groups?",
    x = "Travel Context (Family Size)",
    y = "Survival Rate (%)",
    fill = "Sex",
    subtitle = "Narrowing female advantage in groups suggests coordination breakdown"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray50"),
    axis.text.x = element_text(angle = 15, hjust = 1)
  ) +
  ylim(0, 100)

# Plot 3: Survival by title (social visibility)
p3_norms <- title_survival %>%
  arrange(survival_rate) %>%
  mutate(title = fct_reorder(title, survival_rate)) %>%
  ggplot(aes(x = title, y = survival_rate, fill = survival_rate > 50)) +
  geom_col(alpha = 0.8, color = "black", linewidth = 0.5) +
  scale_fill_manual(values = c("TRUE" = "#8FD14F", "FALSE" = "#E57373")) +
  labs(
    title = "Survival by Social Title: Visibility as a Moderator",
    x = "Passenger Title",
    y = "Survival Rate (%)",
    subtitle = "Different social roles experienced different rule enforcement"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray50"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text.y = element_text(size = 10)
  ) +
  ylim(0, 100)

# Combine and display
p1_norms / p2_norms / p3_norms
```

**Explanation:** These visualizations test the consistency of survival norms across contexts. The first plot reveals whether the sex advantage converges or diverges across classes (hierarchy vs. independence of rules). The second plot shows whether the female advantage persists in family groups or shrinks, indicating whether social coordination enables or constrains norm enforcement. The third plot demonstrates how social visibility (via titles) moderated survival outcomes, suggesting that **formal rules ("women first") were mediated by social structure and recognition**.

---

## Part 4: Research Question 3 — Missing Data as a Social Signal

**Core Question:** Are patterns of missingness (cabin, age) systematically related to class and survival, and how sensitive are conclusions to missing-data assumptions?

**Analytical Strategy:** We investigate whether missingness is *not random* (MNAR)—i.e., whether missing cabin or age data is correlated with class, survival, or other variables. If missingness is systematic, it biases analyses and encodes social inequality.

### 4.1 Missingness Patterns by Class

```{r}
#| label: missingness-by-class

# Calculate missingness by class and survival
missingness_class <- titanic %>%
  group_by(class_label) %>%
  summarise(
    n = n(),
    pct_age_missing = round(100 * mean(age_missing), 1),
    pct_cabin_missing = round(100 * mean(cabin_missing), 1),
    pct_embarked_missing = round(100 * mean(embarked_missing), 1),
    .groups = "drop"
  )

kable(missingness_class,
      caption = "Missingness Rates by Passenger Class",
      col.names = c("Class", "N", "% Age Missing", "% Cabin Missing", "% Embarked Missing"))

# Extract key values
age_miss_1st <- filter(missingness_class, class_label == "1st Class")$pct_age_missing
age_miss_3rd <- filter(missingness_class, class_label == "3rd Class")$pct_age_missing

cabin_miss_1st <- filter(missingness_class, class_label == "1st Class")$pct_cabin_missing
cabin_miss_3rd <- filter(missingness_class, class_label == "3rd Class")$pct_cabin_missing
```

**Explanation:** Missingness patterns reveal data collection inequality. Age is missing for `r age_miss_1st`% of 1st class passengers but `r age_miss_3rd`% of 3rd class passengers, a difference of `r age_miss_3rd - age_miss_1st` percentage points. **More concerning, cabin data is missing for only `r cabin_miss_1st`% of 1st class but `r cabin_miss_3rd`% of 3rd class passengers.** This dramatic differential missingness suggests that 3rd class passengers' locations and identities were recorded less systematically, which itself reflects social marginalization. When analyzing location-based mechanisms (as in Q1), analyses restricted to non-missing cabin data may unknowingly exclude 3rd class passengers, biasing conclusions toward 1st class experiences.

### 4.2 Is Missingness Related to Survival?

```{r}
#| label: missingness-survival-association

# Compare survival rates among those with vs without age data
survival_by_age_missing <- titanic %>%
  group_by(age_missing) %>%
  summarise(
    n = n(),
    n_survived = sum(Survived),
    survival_rate = round(100 * mean(Survived), 1),
    .groups = "drop"
  ) %>%
  mutate(age_missing = if_else(age_missing, "Age Missing", "Age Known"))

# Compare survival rates among those with vs without cabin data
survival_by_cabin_missing <- titanic %>%
  group_by(cabin_missing) %>%
  summarise(
    n = n(),
    n_survived = sum(Survived),
    survival_rate = round(100 * mean(Survived), 1),
    .groups = "drop"
  ) %>%
  mutate(cabin_missing = if_else(cabin_missing, "Cabin Missing", "Cabin Known"))

kable(survival_by_age_missing,
      caption = "Survival Rate by Age Data Availability",
      col.names = c("Age Data Status", "N", "N Survived", "Survival Rate (%)"))

kable(survival_by_cabin_missing,
      caption = "Survival Rate by Cabin Data Availability",
      col.names = c("Cabin Data Status", "N", "N Survived", "Survival Rate (%)"))

# Extract key values
surv_age_known <- filter(survival_by_age_missing, age_missing == "Age Known")$survival_rate
surv_age_missing <- filter(survival_by_age_missing, age_missing == "Age Missing")$survival_rate

surv_cabin_known <- filter(survival_by_cabin_missing, cabin_missing == "Cabin Known")$survival_rate
surv_cabin_missing <- filter(survival_by_cabin_missing, cabin_missing == "Cabin Missing")$survival_rate
```

**Explanation:** If data is *missing completely at random* (MCAR), missingness should not be associated with survival. However, passengers with known age had `r surv_age_known`% survival, while those with missing age had `r surv_age_missing`% survival, a difference of `r surv_age_known - surv_age_missing` percentage points. Passengers with known cabin data had `r surv_cabin_known`% survival versus `r surv_cabin_missing`% with missing cabin data, a gap of `r surv_cabin_known - surv_cabin_missing` percentage points. These associations suggest **the data is not MCAR**; missingness is informative about survival risk. This could mean: (1) passengers whose information was recorded were preferentially rescued (social visibility bias), or (2) the recordkeeping itself reflected social stratification (3rd class less documented, therefore less visible for evacuation).

### 4.3 Sensitivity Analysis: Impact of Missing Data Assumptions

```{r}
#| label: sensitivity-missing-data

# Scenario A: Complete-case analysis (exclude missing cabin/age)
model_cc <- glm(Survived ~ Pclass + Sex + Age + Fare + cabin_letter,
                family = binomial,
                data = filter(titanic, !cabin_missing & !age_missing))

# Scenario B: Impute missing age with class-specific medians
titanic_imputed_age <- titanic %>%
  group_by(Pclass) %>%
  mutate(
    Age_imputed = if_else(age_missing, median(Age, na.rm = TRUE), Age)
  ) %>%
  ungroup()

model_imputed_age <- glm(Survived ~ Pclass + Sex + Age_imputed + Fare,
                         family = binomial,
                         data = filter(titanic_imputed_age, !cabin_missing))

# Scenario C: Indicator variable for missingness (allows data to inform about missingness)
model_missing_ind <- glm(Survived ~ Pclass + Sex + Age + age_missing + Fare,
                         family = binomial,
                         data = filter(titanic, !cabin_missing))

# Compare coefficients across scenarios
coef_comparison <- tibble(
  Variable = "Pclass",
  Complete_Case = round(coef(model_cc)["Pclass"], 4),
  Imputed_Age = round(coef(model_imputed_age)["Pclass"], 4),
  Missing_Indicator = round(coef(model_missing_ind)["Pclass"], 4)
)

kable(coef_comparison,
      caption = "Sensitivity Analysis: Pclass Coefficient Under Different Missing-Data Approaches",
      col.names = c("Variable", "Complete-Case Only", "Class-Median Imputation", "Missing Indicator"))

cc_coef <- coef_comparison$Complete_Case
imp_coef <- coef_comparison$Imputed_Age
ind_coef <- coef_comparison$Missing_Indicator

pct_diff_cc_imp <- round(100 * abs(cc_coef - imp_coef) / abs(cc_coef), 1)
pct_diff_cc_ind <- round(100 * abs(cc_coef - ind_coef) / abs(cc_coef), 1)
```

**Explanation:** Missing data assumptions substantially affect estimates. The complete-case analysis (excluding rows with missing age or cabin, `n = `r nrow(filter(titanic, !cabin_missing & !age_missing))`) estimates a Pclass coefficient of `r cc_coef`. When we impute missing age with class-specific medians, the coefficient becomes `r imp_coef`, a `r pct_diff_cc_imp`% difference. When we include a missing-age indicator variable, the coefficient is `r ind_coef`, a `r pct_diff_cc_ind`% difference. These variations demonstrate **sensitivity to assumptions**. Because missing data is not random but correlated with class (higher missingness in 3rd class), different approaches yield meaningfully different estimates of class effects. Analyses based on complete cases may overstate or understate the true class-survival relationship by excluding underrepresented groups.

### 4.4 Missing Data Visualization and Pattern Detection

```{r}
#| label: viz-missing-patterns

# Create a missingness matrix for visualization
missing_matrix <- titanic %>%
  select(Pclass, class_label, Sex, Age, age_missing, Cabin, cabin_missing, Fare, Embarked, embarked_missing) %>%
  sample_n(min(500, nrow(.)))  # Sample for visualization clarity

# Heatmap of missingness by class
p1_missing <- tibble(
  class_label = rep(c("1st Class", "2nd Class", "3rd Class"), 3),
  variable = rep(c("Age", "Cabin", "Embarked"), each = 3),
  pct_missing = c(
    filter(missingness_class, class_label == "1st Class")$pct_age_missing,
    filter(missingness_class, class_label == "2nd Class")$pct_age_missing,
    filter(missingness_class, class_label == "3rd Class")$pct_age_missing,
    filter(missingness_class, class_label == "1st Class")$pct_cabin_missing,
    filter(missingness_class, class_label == "2nd Class")$pct_cabin_missing,
    filter(missingness_class, class_label == "3rd Class")$pct_cabin_missing,
    filter(missingness_class, class_label == "1st Class")$pct_embarked_missing,
    filter(missingness_class, class_label == "2nd Class")$pct_embarked_missing,
    filter(missingness_class, class_label == "3rd Class")$pct_embarked_missing
  )
) %>%
  mutate(
    class_label = factor(class_label, levels = c("1st Class", "2nd Class", "3rd Class")),
    variable = factor(variable, levels = c("Age", "Cabin", "Embarked"))
  ) %>%
  ggplot(aes(x = variable, y = class_label, fill = pct_missing)) +
  geom_tile(color = "black", linewidth = 0.5) +
  geom_text(aes(label = paste0(pct_missing, "%")), color = "white", size = 4, fontface = "bold") +
  scale_fill_gradient(low = "#2E7D32", high = "#E53935", limits = c(0, 100)) +
  labs(
    title = "Missing Data Patterns: Concentration in 3rd Class",
    x = "Variable",
    y = "Passenger Class",
    fill = "% Missing",
    subtitle = "Systematic missingness reflects recordkeeping inequality"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray50"),
    axis.text = element_text(size = 10)
  )

# Scatter: Missingness type by class
p2_missing <- titanic %>%
  group_by(Pclass) %>%
  summarise(
    age_missing_pct = 100 * mean(age_missing),
    cabin_missing_pct = 100 * mean(cabin_missing),
    .groups = "drop"
  ) %>%
  mutate(Pclass = factor(Pclass, labels = c("1st Class", "2nd Class", "3rd Class"))) %>%
  ggplot(aes(x = age_missing_pct, y = cabin_missing_pct, color = Pclass, size = 4)) +
  geom_point() +
  scale_color_brewer(palette = "Blues", direction = -1) +
  labs(
    title = "Two-Dimensional Missingness by Class",
    x = "Age Missing (%)",
    y = "Cabin Missing (%)",
    color = "Class",
    subtitle = "3rd class concentrated in high-missingness region"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray50"),
    legend.box = "horizontal"
  ) +
  guides(size = "none")

# Survival stratified by missingness status
p3_missing <- titanic %>%
  mutate(
    data_status = case_when(
      age_missing & cabin_missing ~ "Both Missing",
      age_missing ~ "Age Missing",
      cabin_missing ~ "Cabin Missing",
      TRUE ~ "Both Known"
    ),
    data_status = factor(data_status, levels = c("Both Known", "Age Missing", "Cabin Missing", "Both Missing"))
  ) %>%
  group_by(data_status) %>%
  summarise(
    n = n(),
    survival_rate = round(100 * mean(Survived), 1),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = data_status, y = survival_rate, fill = data_status)) +
  geom_col(alpha = 0.8, color = "black", linewidth = 0.5) +
  scale_fill_brewer(palette = "RdYlGn") +
  labs(
    title = "Survival by Data Completeness Status",
    x = "Data Availability",
    y = "Survival Rate (%)",
    subtitle = "Missing data predictive of lower survival (MNAR indicator)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray50"),
    axis.text.x = element_text(angle = 30, hjust = 1)
  ) +
  ylim(0, 100)

# Combine and display
p1_missing / (p2_missing + p3_missing)
```

**Explanation:** The heatmap reveals concentrated missing data in 3rd class, particularly for cabin information. The scatter plot shows the joint distribution: 3rd class occupies the region of high missingness on both dimensions. The survival plot demonstrates that passengers with missing data had lower survival, suggesting that **missingness itself is a marker of social marginalization**. Passengers with both age and cabin data had the highest survival, likely because both recording and rescue were more systematic for 1st class. This finding has important implications: analyses that rely on complete-case deletion may inadvertently exclude the most vulnerable populations (3rd class, poorly documented) and overestimate survival advantages of well-documented groups.

---

## Part 5: Integrated Recommendations for Future Analysis

### 5.1 Methodological Takeaways

Based on this exploratory analysis, we recommend the following approaches for addressing each research question:

**For Q1 (Class-Survival Gap and Access):**
- Employ mediation analysis formally (using `mediation` package or manual approach) to decompose class effects into direct and indirect (via access proxies) pathways.
- Examine deck-level survival patterns when cabin letters are available, testing whether physical location explains class advantage.
- Consider propensity-score matching on fare to isolate class effects independent of ticket price.

**For Q2 (Norm Consistency):**
- Fit logistic models with interaction terms (e.g., `Sex × Class`, `Sex × FamilySize`, `Title × Class`) to formally test whether demographic rules held uniformly.
- Stratify survival analysis by travel context to identify populations where "women first" was enforced versus abandoned.
- Use causal forest methods to identify subgroups with heterogeneous treatment effects (e.g., does "female" advantage depend on class?).

**For Q3 (Missing Data as Social Signal):**
- Conduct MNAR sensitivity analyses with different assumptions about what unobserved data would have looked like.
- Use multiple imputation (with pattern-mixture or selection models) to propagate uncertainty from missingness into estimates.
- Report results under different missing-data scenarios, making transparent the dependence of conclusions on untestable assumptions.

### 5.2 Data Quality and Recordkeeping Inequality

```{r}
#| label: data-quality-summary

data_quality_summary <- tibble(
  Aspect = c(
    "Age Completeness",
    "Cabin Documentation",
    "Embarkation Recording",
    "Class × Age Missingness",
    "Class × Cabin Missingness"
  ),
  Finding = c(
    paste0("Age missing for ", round(100*mean(titanic$age_missing),1), "% of passengers"),
    paste0("Cabin missing for ", round(100*mean(titanic$cabin_missing),1), "% of passengers"),
    paste0("Embarked missing for ", round(100*mean(titanic$embarked_missing),1), "% of passengers"),
    paste0("1st class: ", age_miss_1st, "% missing; 3rd class: ", age_miss_3rd, "% missing"),
    paste0("1st class: ", cabin_miss_1st, "% missing; 3rd class: ", cabin_miss_3rd, "% missing")
  ),
  Interpretation = c(
    "Moderate overall incompleteness; does not appear random",
    "Extreme incompleteness; strongly concentrated in 3rd class",
    "Minimal; primarily affects 2nd class embarkation port",
    "Differential by class: lower-class passengers less systematically documented",
    "Severe inequality: 3rd class cabin locations much more likely undocumented"
  )
)

kable(data_quality_summary,
      caption = "Data Quality as Reflection of Recordkeeping Inequality",
      col.names = c("Aspect", "Empirical Finding", "Interpretation for Social Inequality"))
```

**Explanation:** The data itself encodes historical inequality: cabin information for 3rd class passengers was documented `r round(cabin_miss_3rd - cabin_miss_1st, 1)` percentage points less frequently than for 1st class. This is not merely a statistical problem; it is a **historical artifact** reflecting how 3rd class passengers were regarded as less important to record systematically. When analyzing survival mechanisms, this missingness bias means we have detailed location information primarily for those who survived (1st class) and poor information for those who faced greatest danger (3rd class). Any location-based survival explanation risks being circular: we know 1st class cabin locations because they survived, survived because they had better (recorded) locations, but we cannot assess 3rd class locations because that information was never preserved.

---

## Conclusion

This report has outlined three interconnected investigative strategies for understanding Titanic survival inequality:

1. **Mediation Analysis** reveals that survival advantages of 1st class were partially mediated by access proxies (fare, cabin letter), though a substantial direct class effect remains.
2. **Interaction Analysis** demonstrates that demographic survival rules ("women and children first") were not applied uniformly—they were stronger in higher classes and may have broken down under coordination pressure in large groups.
3. **Missing Data Analysis** shows that data incompleteness is itself a marker of social marginalization, concentrated in 3rd class, and systematic assumptions about missing data substantially affect estimated effects.

Rather than answering these questions definitively, this analysis provides a methodological foundation for investigating them rigorously. Future work should employ formal mediation analysis, interaction testing, and sensitivity analysis to MNAR assumptions, while remaining transparent about the extent to which historical inequality in recordkeeping constrains what we can conclude about the Titanic disaster.

---

## References and Appendix

### Data Source
- Titanic: Machine Learning from Disaster (Kaggle)
- Training set: `train.csv` (n = `r nrow(titanic_raw)` passengers)

### Key Variables Used
- **Survived**: Binary outcome (0 = died, 1 = survived)
- **Pclass**: Passenger class (1/2/3)
- **Sex**: Biological sex (male/female)
- **Age**: Age in years (fractional for infants)
- **Fare**: Ticket price (proxy for access/location)
- **Cabin**: Cabin number (used to extract deck letter)
- **Name**: Used to extract title (Mr., Mrs., Miss., Master.)
- **SibSp, Parch**: Family relationships (used to construct travel context)

### Session Information
```{r}
sessionInfo()
```
