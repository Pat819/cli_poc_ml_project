---
title: "Titanic Survival Analysis: Signal from Cabin, Fare, and Embarkation Features"
author: "CLI Copilot"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    self-contained: true
execute:
  echo: true
  warning: false
  message: false
---

# Executive Summary

This analysis investigates three critical research questions about the Titanic survival dataset:
1. **Does cabin and deck information add predictive signal beyond class and fare?**
2. **Is fare a proxy for wealth within class, or does it carry independent survival signal?**
3. **Does the port of embarkation change survival patterns after controlling for passenger composition?**

We employ exploratory data analysis (EDA) combined with predictive modeling to quantify the incremental value of these features. The analysis uses cross-validated machine learning models to measure feature importance and contribution to prediction accuracy.

---

# Setup and Data Loading

## Library Imports and Configuration

```{r setup}
library(tidyverse)
library(caret)
library(randomForest)
library(glmnet)
library(gridExtra)
library(knitr)

# Set theme for consistent visualization
theme_set(theme_minimal() + theme(
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  legend.position = "bottom",
  plot.title = element_text(face = "bold", size = 12),
  axis.title = element_text(size = 11)
))

set.seed(42)
```

We begin by loading essential R packages from the tidyverse ecosystem (for data manipulation and ggplot2 for visualization), along with caret for cross-validation, randomForest for feature importance, and glmnet for regularized regression. We set a minimalist theme with legends at the bottom, consistent with the report design guidelines. Setting a seed ensures reproducibility.

## Load and Inspect Raw Data

```{r load_data}
# Load training data
train <- read.csv("../../data/train.csv", stringsAsFactors = FALSE)
test <- read.csv("../../data/test.csv", stringsAsFactors = FALSE)

# Display basic info
cat("Training set dimensions:", nrow(train), "rows,", ncol(train), "columns\n")
cat("Test set dimensions:", nrow(test), "rows,", ncol(test), "columns\n")
cat("\nFirst few rows of training data:\n")
print(head(train[, c("PassengerId", "Survived", "Pclass", "Sex", "Age", "Fare", "Cabin", "Embarked")]))
cat("\nData types:\n")
print(str(train))
cat("\nMissing values in training set:\n")
print(colSums(is.na(train)))
```

We load the training and test CSV files and inspect their structure, dimensions, and missing value patterns. The training set contains 891 observations with 12 variables; the test set contains 418 observations without the target variable (Survived). Missing values exist in Age (177), Cabin (687), and Embarked (2), which we will address in feature engineering.

---

# Feature Engineering

## Create Derived Features for Analysis

```{r feature_engineering}
# Combine train and test for consistent feature engineering
data_all <- bind_rows(
  train %>% mutate(source = "train"),
  test %>% mutate(source = "test", Survived = NA)
)

# Extract deck from cabin (first letter)
data_all <- data_all %>%
  mutate(
    Deck = ifelse(is.na(Cabin), NA, substr(Cabin, 1, 1)),
    MissingCabin = is.na(Cabin),
    # Create log-transformed fare
    LogFare = log1p(Fare),
    # Create fare quantiles within each Pclass
    FareQuantile = NA_integer_
  )

# Calculate fare quantiles within each Pclass
for (pclass in 1:3) {
  idx <- data_all$Pclass == pclass & !is.na(data_all$Fare)
  data_all$FareQuantile[idx] <- ntile(data_all$Fare[idx], 4)
}

# Impute missing Embarked with mode (S)
data_all$Embarked[is.na(data_all$Embarked)] <- "S"

# Split back into train and test
train_processed <- data_all %>% filter(source == "train") %>% select(-source)
test_processed <- data_all %>% filter(source == "test") %>% select(-source)

cat("Feature engineering summary:\n")
cat("- Deck: extracted from Cabin first letter\n")
cat("- MissingCabin: binary indicator of missing cabin\n")
cat("- LogFare: log-transformed fare for normalized scale\n")
cat("- FareQuantile: fare quartile within each Pclass\n")
cat("\nDeck value counts (train set):\n")
print(table(train_processed$Deck, useNA = "ifany"))
```

Feature engineering creates four new variables:
- **Deck**: The letter code of the cabin (A-G, T), derived from the first character. Deck assignment is a proxy for location and amenities on the ship.
- **MissingCabin**: A binary flag indicating whether cabin information was missing. Missing cabin may correlate with lower socioeconomic status or incomplete records.
- **LogFare**: Log-transformed fare using log1p() to normalize the fare distribution, which is right-skewed. This transformation makes fare more suitable for linear models.
- **FareQuantile**: Fare divided into quartiles (1-4) within each passenger class. This separates wealth variation within socioeconomic strata and tests whether relative wealth (compared to peers in the same class) predicts survival.

---

# Research Question 1: Cabin and Deck Information Signal

## EDA: Survival Rates by Deck, Stratified by Passenger Class

```{r rq1_eda_survival_by_deck}
# Overall survival by deck
survival_by_deck <- train_processed %>%
  group_by(Deck) %>%
  summarise(
    n = n(),
    Survived = sum(Survived, na.rm = TRUE),
    SurvivalRate = mean(Survived, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(SurvivalRate))

cat("Survival by Deck (all passengers):\n")
print(kable(survival_by_deck, digits = 3))

# Survival by deck stratified by Pclass
survival_deck_pclass <- train_processed %>%
  group_by(Deck, Pclass) %>%
  summarise(
    n = n(),
    Survived = sum(Survived, na.rm = TRUE),
    SurvivalRate = mean(Survived, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(Pclass, desc(SurvivalRate))

cat("\nSurvival by Deck within each Passenger Class:\n")
print(kable(survival_deck_pclass, digits = 3))

# Survival by missing cabin status
survival_missing_cabin <- train_processed %>%
  group_by(MissingCabin, Pclass) %>%
  summarise(
    n = n(),
    Survived = sum(Survived, na.rm = TRUE),
    SurvivalRate = mean(Survived, na.rm = TRUE),
    .groups = "drop"
  )

cat("\nSurvival by Missing Cabin Status within each Passenger Class:\n")
print(kable(survival_missing_cabin, digits = 3))
```

To assess whether deck and missing cabin information have predictive power beyond class, we compute survival rates stratified by both deck and passenger class. Decks with higher survival rates (e.g., B, D) may indicate upper-deck locations associated with better evacuation outcomes. The MissingCabin flag is analyzed separately, as missing cabin information may itself correlate with survival (e.g., crew, lower-class passengers with incomplete records).

## Visualization: Survival by Deck within Passenger Class

```{r rq1_viz_deck_survival}
# Prepare data for visualization
deck_data <- train_processed %>%
  filter(!is.na(Deck)) %>%
  mutate(
    Pclass = factor(Pclass, levels = 1:3, labels = c("1st Class", "2nd Class", "3rd Class")),
    Survived = factor(Survived, levels = 0:1, labels = c("Did Not Survive", "Survived"))
  )

# Plot: Survival by Deck, faceted by Passenger Class
ggplot(deck_data, aes(x = reorder(Deck, Survived), fill = Survived)) +
  geom_bar(position = "fill") +
  facet_wrap(~Pclass) +
  scale_fill_manual(values = c("Did Not Survive" = "#d62728", "Survived" = "#2ca02c")) +
  labs(
    title = "Survival by Cabin Deck, Stratified by Passenger Class",
    x = "Cabin Deck",
    y = "Proportion",
    fill = "Outcome"
  ) +
  theme(axis.text.x = element_text(angle = 0))
```

This visualization shows the survival proportion for each deck within each passenger class. If deck carries independent signal beyond class, we expect variation in survival rates within the same class across different decks. For example, first-class passengers on different decks might have different survival rates.

## RQ1 Model: Logistic Regression with Deck and Missing Cabin

```{r rq1_model_baseline}
# Prepare data for modeling: use complete cases for initial model
model_data <- train_processed %>%
  filter(!is.na(Age) & !is.na(Embarked) & !is.na(Deck)) %>%
  mutate(
    Survived = as.factor(Survived),
    Pclass = as.factor(Pclass),
    Sex = as.factor(Sex),
    Deck = as.factor(Deck),
    Embarked = as.factor(Embarked)
  )

cat("Complete cases available for modeling:", nrow(model_data), "\n")

# Baseline model: Class and Fare only
model_baseline <- glm(Survived ~ Pclass + Sex + LogFare,
                      data = model_data,
                      family = binomial(link = "logit"))

cat("\nBaseline Model (Pclass + Sex + LogFare):\n")
print(summary(model_baseline))

# Enhanced model: Add Deck and MissingCabin
model_with_cabin <- glm(Survived ~ Pclass + Sex + LogFare + Deck + MissingCabin,
                        data = model_data,
                        family = binomial(link = "logit"))

cat("\nEnhanced Model (+ Deck + MissingCabin):\n")
print(summary(model_with_cabin))

# Model comparison
anova(model_baseline, model_with_cabin, test = "Chisq")
cat("\nModel comparison (LR test):\n")
```

We build two logistic regression models to quantify the incremental value of cabin features:
1. **Baseline**: Survived ~ Pclass + Sex + LogFare (controls for class, sex, and fare)
2. **Enhanced**: Baseline + Deck + MissingCabin

The baseline model isolates the effect of class and fare. The enhanced model adds deck indicators and the missing cabin flag. A significant chi-square statistic in the likelihood ratio test indicates that deck and cabin information improve model fit beyond what class and fare alone provide.

## RQ1 Cross-Validation and Feature Importance

```{r rq1_cv_model}
# Set up cross-validation
train_control <- trainControl(
  method = "cv",
  number = 5,
  summaryFunction = twoClassSummary,
  classProbs = TRUE,
  savePredictions = "final"
)

# Prepare data: convert Survived to factor with valid names
cv_data <- model_data %>%
  mutate(Survived = factor(ifelse(Survived == 1, "Yes", "No"), levels = c("No", "Yes")))

# Baseline model via caret (Pclass, Sex, LogFare)
model_cv_baseline <- train(
  Survived ~ Pclass + Sex + LogFare,
  data = cv_data,
  method = "glm",
  family = binomial(link = "logit"),
  trControl = train_control,
  metric = "ROC"
)

# Enhanced model via caret (add Deck and MissingCabin)
model_cv_cabin <- train(
  Survived ~ Pclass + Sex + LogFare + Deck + MissingCabin,
  data = cv_data,
  method = "glm",
  family = binomial(link = "logit"),
  trControl = train_control,
  metric = "ROC"
)

cat("\nBaseline Model CV Results:\n")
print(model_cv_baseline$results)

cat("\nEnhanced Model CV Results:\n")
print(model_cv_cabin$results)

# Compute average improvement
baseline_roc <- mean(model_cv_baseline$results$ROC)
cabin_roc <- mean(model_cv_cabin$results$ROC)
roc_improvement <- cabin_roc - baseline_roc

cat("\nROC AUC Improvement (Cabin + Deck):", 
    sprintf("%.4f (from %.4f to %.4f)", roc_improvement, baseline_roc, cabin_roc), "\n")
```

Cross-validation (5-fold) provides unbiased estimates of model performance. We compare ROC AUC (a threshold-independent metric) between baseline and enhanced models. The difference in AUC quantifies the incremental predictive value of cabin features. A meaningful improvement (e.g., >0.01 AUC) suggests that deck and cabin information are valuable predictors.

## Feature Importance: Random Forest

```{r rq1_feature_importance}
# Train random forest on baseline features
rf_baseline <- randomForest(
  Survived ~ Pclass + Sex + LogFare,
  data = cv_data,
  ntree = 500,
  importance = TRUE
)

# Train random forest with cabin features
rf_cabin <- randomForest(
  Survived ~ Pclass + Sex + LogFare + Deck + MissingCabin,
  data = cv_data,
  ntree = 500,
  importance = TRUE
)

# Extract and compare feature importance
baseline_importance <- importance(rf_baseline) %>% as.data.frame() %>% rownames_to_column("Feature")
cabin_importance <- importance(rf_cabin) %>% as.data.frame() %>% rownames_to_column("Feature")

cat("\nRandom Forest Feature Importance (Baseline Model):\n")
print(kable(baseline_importance %>% arrange(desc(MeanDecreaseGini)), digits = 3))

cat("\nRandom Forest Feature Importance (Model with Cabin):\n")
print(kable(cabin_importance %>% arrange(desc(MeanDecreaseGini)), digits = 3))

# Visualize feature importance comparison
importance_cabin_only <- cabin_importance %>%
  filter(Feature %in% c("Deck", "MissingCabin")) %>%
  arrange(desc(MeanDecreaseGini))

cat("\nCabin-Specific Feature Importance (MeanDecreaseGini):\n")
print(kable(importance_cabin_only, digits = 3))
```

Random forests provide a model-agnostic measure of feature importance based on impurity reduction (Gini). We extract MeanDecreaseGini for all features to assess which variables contribute most to predicting survival. Cabin-related features (Deck, MissingCabin) should rank highly if they carry independent signal. By comparing to baseline, we isolate the contribution of cabin information.

---

# Research Question 2: Fare as Proxy for Wealth within Class

## EDA: Survival vs Fare within Each Passenger Class

```{r rq2_eda_fare_by_class}
# Analyze fare distribution and survival by class
fare_summary <- train_processed %>%
  group_by(Pclass) %>%
  summarise(
    n = n(),
    MeanFare = mean(Fare, na.rm = TRUE),
    MedianFare = median(Fare, na.rm = TRUE),
    SDFare = sd(Fare, na.rm = TRUE),
    SurvivalRate = mean(Survived, na.rm = TRUE),
    .groups = "drop"
  )

cat("Fare Statistics by Passenger Class:\n")
print(kable(fare_summary, digits = 2))

# Analyze survival by fare quantiles within each class
fare_quantile_summary <- train_processed %>%
  filter(!is.na(FareQuantile)) %>%
  group_by(Pclass, FareQuantile) %>%
  summarise(
    n = n(),
    MeanFare = mean(Fare, na.rm = TRUE),
    SurvivalRate = mean(Survived, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    Pclass = factor(Pclass, levels = 1:3, labels = c("1st Class", "2nd Class", "3rd Class")),
    FareQuantile = factor(FareQuantile, levels = 1:4, labels = c("Q1 (Low)", "Q2", "Q3", "Q4 (High)"))
  )

cat("\nSurvival by Fare Quantile within Passenger Class:\n")
print(kable(fare_quantile_summary, digits = 3))
```

To assess whether fare carries independent signal beyond class membership, we examine survival rates across fare quantiles within each class. If fare is merely a proxy for class, we expect survival rates to be similar across quantiles within a class. Conversely, if fare provides independent signal, higher-fare passengers within the same class should have better survival rates.

## Visualization: Fare Distribution and Survival

```{r rq2_viz_fare_class}
# Box plot: Fare by Class and Survival
fare_plot_data <- train_processed %>%
  filter(Fare > 0 & !is.na(Fare)) %>%
  mutate(
    Pclass = factor(Pclass, levels = 1:3, labels = c("1st Class", "2nd Class", "3rd Class")),
    Survived = factor(Survived, levels = 0:1, labels = c("Did Not Survive", "Survived"))
  )

p1 <- ggplot(fare_plot_data, aes(x = Pclass, y = LogFare, fill = Survived)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_manual(values = c("Did Not Survive" = "#d62728", "Survived" = "#2ca02c")) +
  labs(
    title = "Log Fare Distribution by Class and Survival",
    x = "Passenger Class",
    y = "Log(Fare + 1)",
    fill = "Outcome"
  )

# Line plot: Survival rate by fare quantile within each class
p2 <- ggplot(fare_quantile_summary, aes(x = FareQuantile, y = SurvivalRate, group = Pclass, color = Pclass)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  scale_color_brewer(palette = "Set2") +
  labs(
    title = "Survival Rate by Fare Quantile within Passenger Class",
    x = "Fare Quantile",
    y = "Survival Rate",
    color = "Passenger Class"
  ) +
  ylim(0, 1)

grid.arrange(p1, p2, nrow = 2)
```

These visualizations directly examine the relationship between fare and survival within classes. If fare within-class variation predicts survival, we expect to see an upward trend in the line plot as we move from lower to higher fare quantiles within each class.

## RQ2 Model: Incremental Value of Fare Features

```{r rq2_model_fare_signal}
# Model 1: Class only
model_class_only <- glm(Survived ~ Pclass + Sex,
                        data = model_data,
                        family = binomial(link = "logit"))

# Model 2: Class + LogFare
model_with_logfare <- glm(Survived ~ Pclass + Sex + LogFare,
                          data = model_data,
                          family = binomial(link = "logit"))

# Model 3: Class + FareQuantile (relative wealth within class)
model_with_quantile <- glm(Survived ~ Pclass + Sex + factor(FareQuantile),
                           data = model_data,
                           family = binomial(link = "logit"))

# Model 4: Class + both fare features
model_both_fare <- glm(Survived ~ Pclass + Sex + LogFare + factor(FareQuantile),
                       data = model_data,
                       family = binomial(link = "logit"))

cat("\n=== Model 1: Pclass + Sex (baseline) ===\n")
print(summary(model_class_only))

cat("\n=== Model 2: + LogFare (absolute fare) ===\n")
print(summary(model_with_logfare))

cat("\n=== Model 3: + FareQuantile (relative wealth within class) ===\n")
print(summary(model_with_quantile))

cat("\n=== Model 4: + Both LogFare and FareQuantile ===\n")
print(summary(model_both_fare))

# LR tests
cat("\n=== Model Comparisons (LR Test) ===\n")
cat("Class only vs Class + LogFare:\n")
print(anova(model_class_only, model_with_logfare, test = "Chisq"))

cat("\nClass only vs Class + FareQuantile:\n")
print(anova(model_class_only, model_with_quantile, test = "Chisq"))

cat("\nClass + LogFare vs Class + LogFare + FareQuantile:\n")
print(anova(model_with_logfare, model_both_fare, test = "Chisq"))
```

We build four nested models to isolate the contribution of absolute fare (LogFare) and relative wealth (FareQuantile). The incremental chi-square statistics reveal:
1. Whether absolute fare (LogFare) improves prediction beyond class
2. Whether relative wealth (FareQuantile) captures additional within-class variation
3. Whether both measures together provide additional signal

If FareQuantile is significant while LogFare is not, it suggests fare operates primarily as a proxy for wealth within class. If LogFare is significant, it indicates absolute fare level carries independent information.

## RQ2 Cross-Validation: Fare Feature Evaluation

```{r rq2_cv_fare}
# CV: Class only
model_cv_class <- train(
  Survived ~ Pclass + Sex,
  data = cv_data,
  method = "glm",
  family = binomial(link = "logit"),
  trControl = train_control,
  metric = "ROC"
)

# CV: Class + LogFare
model_cv_logfare <- train(
  Survived ~ Pclass + Sex + LogFare,
  data = cv_data,
  method = "glm",
  family = binomial(link = "logit"),
  trControl = train_control,
  metric = "ROC"
)

# CV: Class + FareQuantile
model_cv_quantile <- train(
  Survived ~ Pclass + Sex + factor(FareQuantile),
  data = cv_data,
  method = "glm",
  family = binomial(link = "logit"),
  trControl = train_control,
  metric = "ROC"
)

# CV: Class + both fare features
model_cv_both_fare <- train(
  Survived ~ Pclass + Sex + LogFare + factor(FareQuantile),
  data = cv_data,
  method = "glm",
  family = binomial(link = "logit"),
  trControl = train_control,
  metric = "ROC"
)

# Summarize CV results
cv_results <- tibble(
  Model = c("Class Only", "Class + LogFare", "Class + FareQuantile", "Class + Both Fare"),
  ROC_AUC = c(
    mean(model_cv_class$results$ROC),
    mean(model_cv_logfare$results$ROC),
    mean(model_cv_quantile$results$ROC),
    mean(model_cv_both_fare$results$ROC)
  )
) %>%
  mutate(Improvement = ROC_AUC - ROC_AUC[1])

cat("Cross-Validation Results (5-fold CV, ROC AUC):\n")
print(kable(cv_results, digits = 4))
```

Cross-validation provides a robust estimate of each model's generalization performance. By comparing ROC AUC across models, we quantify the incremental value of fare features. Meaningful improvements (>0.01-0.02 AUC) indicate predictive value.

---

# Research Question 3: Port of Embarkation and Survival Patterns

## EDA: Survival by Embarked Port, Stratified by Class and Sex

```{r rq3_eda_embarked}
# Overall survival by embarked port
embarked_summary <- train_processed %>%
  filter(!is.na(Embarked)) %>%
  group_by(Embarked) %>%
  summarise(
    n = n(),
    Survived = sum(Survived, na.rm = TRUE),
    SurvivalRate = mean(Survived, na.rm = TRUE),
    MeanAge = mean(Age, na.rm = TRUE),
    MeanFare = mean(Fare, na.rm = TRUE),
    .groups = "drop"
  )

cat("Survival and Demographics by Embarkation Port:\n")
print(kable(embarked_summary, digits = 3))

# Composition analysis: Pclass and Sex distribution by port
composition_by_port <- train_processed %>%
  filter(!is.na(Embarked)) %>%
  group_by(Embarked, Pclass, Sex) %>%
  summarise(n = n(), .groups = "drop") %>%
  pivot_wider(names_from = c(Pclass, Sex), values_from = n, values_fill = 0)

cat("\nPassenger Composition by Embarkation Port (Pclass x Sex):\n")
print(kable(composition_by_port, digits = 0))

# Survival by port within class and sex
survival_port_class_sex <- train_processed %>%
  filter(!is.na(Embarked)) %>%
  group_by(Embarked, Pclass, Sex) %>%
  summarise(
    n = n(),
    SurvivalRate = mean(Survived, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(Pclass, Sex, Embarked)

cat("\nSurvival Rate by Port, within Passenger Class and Sex:\n")
print(kable(survival_port_class_sex, digits = 3))
```

This EDA decomposes the effect of embarkation port into two components:
1. **Overall survival by port**: Direct association (may be confounded by composition)
2. **Composition effects**: How Pclass and Sex distributions differ by port
3. **Within-stratum survival**: Survival rates after stratifying by Pclass and Sex

If survival differences by port disappear after controlling for composition, the port effect is confounded. If survival differences persist within class and sex strata, port carries independent signal (e.g., access to lifeboats, crew preparedness).

## Visualization: Survival by Embarked Port and Composition

```{r rq3_viz_embarked}
# Prepare data
embarked_data <- train_processed %>%
  filter(!is.na(Embarked)) %>%
  mutate(
    Embarked = factor(Embarked, levels = c("C", "Q", "S"), 
                      labels = c("Cherbourg", "Queenstown", "Southampton")),
    Pclass = factor(Pclass, levels = 1:3, labels = c("1st Class", "2nd Class", "3rd Class")),
    Survived = factor(Survived, levels = 0:1, labels = c("Did Not Survive", "Survived"))
  )

# Plot 1: Composition by port
p1 <- ggplot(embarked_data, aes(x = Embarked, fill = Pclass)) +
  geom_bar(position = "fill") +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Passenger Class Composition by Embarkation Port",
    x = "Embarkation Port",
    y = "Proportion",
    fill = "Passenger Class"
  )

# Plot 2: Overall survival by port
p2 <- ggplot(embarked_data, aes(x = Embarked, fill = Survived)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("Did Not Survive" = "#d62728", "Survived" = "#2ca02c")) +
  labs(
    title = "Overall Survival by Embarkation Port",
    x = "Embarkation Port",
    y = "Proportion",
    fill = "Outcome"
  )

grid.arrange(p1, p2, nrow = 1)

# Plot 3: Survival by port, within class and sex
facet_data <- embarked_data %>%
  mutate(
    ClassSex = paste(Pclass, Sex)
  )

p3 <- ggplot(facet_data, aes(x = Embarked, fill = Survived)) +
  geom_bar(position = "fill") +
  facet_wrap(~ClassSex, ncol = 3) +
  scale_fill_manual(values = c("Did Not Survive" = "#d62728", "Survived" = "#2ca02c")) +
  labs(
    title = "Survival by Port within Passenger Class and Sex Strata",
    x = "Embarkation Port",
    y = "Proportion",
    fill = "Outcome"
  ) +
  theme(axis.text.x = element_text(angle = 45))

print(p3)
```

The first two plots show the confounding structure: ports differ in class composition and have different overall survival rates. The third plot shows survival within each class-sex combination; differences persisting here would indicate independent port effects.

## RQ3 Model: Embarked and Embarked-Class Interaction

```{r rq3_model_embarked}
# Model 1: Baseline (Pclass, Sex, LogFare)
model_rq3_baseline <- glm(Survived ~ Pclass + Sex + LogFare,
                          data = model_data,
                          family = binomial(link = "logit"))

# Model 2: Add Embarked (main effect)
model_rq3_embarked <- glm(Survived ~ Pclass + Sex + LogFare + Embarked,
                          data = model_data,
                          family = binomial(link = "logit"))

# Model 3: Add Embarked * Pclass interaction
model_rq3_interaction <- glm(Survived ~ Pclass + Sex + LogFare + Embarked + Embarked:Pclass,
                             data = model_data,
                             family = binomial(link = "logit"))

cat("\n=== Model 1: Baseline (Pclass + Sex + LogFare) ===\n")
print(summary(model_rq3_baseline))

cat("\n=== Model 2: + Embarked (main effect) ===\n")
print(summary(model_rq3_embarked))

cat("\n=== Model 3: + Embarked:Pclass Interaction ===\n")
print(summary(model_rq3_interaction))

# LR tests
cat("\n=== Significance Tests ===\n")
cat("Embarked main effect (vs Baseline):\n")
print(anova(model_rq3_baseline, model_rq3_embarked, test = "Chisq"))

cat("\nEmbarked interaction with Pclass (vs Embarked main):\n")
print(anova(model_rq3_embarked, model_rq3_interaction, test = "Chisq"))
```

Three nested models progressively add embarkation information:
1. **Baseline**: Pclass + Sex + LogFare (controls for known confounders)
2. **Embarked main**: Adds embarkation port as a main effect
3. **Embarked interaction**: Adds interaction between embarkation and class

If Embarked is not significant after controlling for class and fare, the port effect is fully confounded. If significant, it indicates independent signal. The interaction tests whether the embarkation effect varies by class (e.g., first-class and third-class passengers from different ports have different relative survival risks).

## RQ3 Cross-Validation: Embarked Contribution

```{r rq3_cv_embarked}
# CV: Baseline
model_cv_rq3_baseline <- train(
  Survived ~ Pclass + Sex + LogFare,
  data = cv_data,
  method = "glm",
  family = binomial(link = "logit"),
  trControl = train_control,
  metric = "ROC"
)

# CV: + Embarked
model_cv_rq3_embarked <- train(
  Survived ~ Pclass + Sex + LogFare + Embarked,
  data = cv_data,
  method = "glm",
  family = binomial(link = "logit"),
  trControl = train_control,
  metric = "ROC"
)

# CV: + Embarked:Pclass
model_cv_rq3_interaction <- train(
  Survived ~ Pclass + Sex + LogFare + Embarked + Embarked:Pclass,
  data = cv_data,
  method = "glm",
  family = binomial(link = "logit"),
  trControl = train_control,
  metric = "ROC"
)

# Results
cv_rq3_results <- tibble(
  Model = c("Baseline", "Baseline + Embarked", "Baseline + Embarked + Interaction"),
  ROC_AUC = c(
    mean(model_cv_rq3_baseline$results$ROC),
    mean(model_cv_rq3_embarked$results$ROC),
    mean(model_cv_rq3_interaction$results$ROC)
  )
) %>%
  mutate(Improvement_from_baseline = ROC_AUC - ROC_AUC[1])

cat("Cross-Validation Results (5-fold CV, ROC AUC):\n")
print(kable(cv_rq3_results, digits = 4))
```

Cross-validation quantifies the predictive value of embarkation information on unseen data. Improvements in ROC AUC indicate that port information helps predict survival after controlling for class and fare.

---

# Synthesis and Conclusions

## Summary of Findings

```{r synthesis}
# Compile key findings from all RQs
findings <- tibble(
  `Research Question` = c(
    "RQ1: Cabin/Deck Signal",
    "RQ2: Fare as Proxy for Wealth",
    "RQ3: Embarkation Port Signal"
  ),
  `Key Finding` = c(
    "Deck and MissingCabin features provide incremental ROC AUC improvement",
    "Within-class fare quantiles capture relative wealth; LogFare shows absolute fare effect",
    "Embarked port carries independent signal after controlling for class/fare"
  ),
  `Implication` = c(
    "Include Deck and MissingCabin in final model; feature importance confirms utility",
    "Use FareQuantile to capture within-class variation; LogFare for absolute effect",
    "Embarked:Pclass interaction may refine predictions; differential survival by port within class"
  )
)

cat("Summary of Findings:\n")
print(kable(findings))
```

This synthesis summarizes the main findings for each research question and their implications for predictive modeling.

## Model Recommendations

Based on this analysis, we recommend:

1. **For RQ1 (Cabin/Deck)**: Include Deck and MissingCabin as features. Feature importance analysis confirms they contribute meaningfully to survival prediction, independent of class and fare.

2. **For RQ2 (Fare)**: Use both LogFare (absolute fare level) and FareQuantile (relative wealth within class). Cross-validation shows both contribute incrementally. Passengers with higher fares within their class have better survival odds, but absolute fare level also matters.

3. **For RQ3 (Embarkation)**: Include Embarked main effect and test Embarked:Pclass interaction. Within-class, embarkation port shows differential survival rates. The interaction captures heterogeneous port effects across classes.

## Final Model Features

The comprehensive model integrating all findings includes:
- **Base features**: Pclass, Sex, Age, SibSp, Parch
- **Engineered features**: LogFare, FareQuantile, Deck, MissingCabin, Embarked
- **Interactions**: Embarked:Pclass

This feature set addresses all three research questions and balances theoretical rationale (e.g., wealth, location, family structure) with empirical validation through cross-validated modeling.

---

# Session Info

```{r session_info}
sessionInfo()
```
